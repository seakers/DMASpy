
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>agent &#8212; 3D-CHESS 0 documentation</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/alabaster.css" />
    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/sphinx_highlight.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
   
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for agent</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">asyncio</span>
<span class="kn">from</span> <span class="nn">curses</span> <span class="kn">import</span> <span class="n">def_prog_mode</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">shutil</span>

<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">zmq</span>
<span class="kn">import</span> <span class="nn">zmq.asyncio</span>
<span class="kn">import</span> <span class="nn">logging</span>

<span class="kn">from</span> <span class="nn">messages</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">utils</span> <span class="kn">import</span> <span class="n">SimClocks</span><span class="p">,</span> <span class="n">Container</span><span class="p">,</span> <span class="n">EnvironmentModuleTypes</span>

<span class="kn">from</span> <span class="nn">modules</span> <span class="kn">import</span> <span class="o">*</span>

<span class="kn">from</span> <span class="nn">science</span> <span class="kn">import</span> <span class="n">ScienceModule</span>
<span class="kn">from</span> <span class="nn">planning</span> <span class="kn">import</span> <span class="n">PlanningModule</span>
<span class="kn">from</span> <span class="nn">engineering</span> <span class="kn">import</span> <span class="n">EngineeringModule</span>
<span class="kn">from</span> <span class="nn">ground_engineering</span> <span class="kn">import</span> <span class="n">GroundEngineeringModule</span>
<span class="kn">from</span> <span class="nn">iridium_engineering</span> <span class="kn">import</span> <span class="n">IridiumEngineeringModule</span>
<span class="kn">from</span> <span class="nn">json</span> <span class="kn">import</span> <span class="n">JSONEncoder</span>

<span class="k">def</span> <span class="nf">_default</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="vm">__class__</span><span class="p">,</span> <span class="s2">&quot;to_json&quot;</span><span class="p">,</span> <span class="n">_default</span><span class="o">.</span><span class="n">default</span><span class="p">)(</span><span class="n">obj</span><span class="p">)</span>

<span class="n">_default</span><span class="o">.</span><span class="n">default</span> <span class="o">=</span> <span class="n">JSONEncoder</span><span class="p">()</span><span class="o">.</span><span class="n">default</span>
<span class="n">JSONEncoder</span><span class="o">.</span><span class="n">default</span> <span class="o">=</span> <span class="n">_default</span>

<span class="sd">&quot;&quot;&quot;    </span>
<span class="sd">--------------------------------------------------------</span>
<span class="sd"> ______                         __        ____    ___                       __      </span>
<span class="sd">/\  _  \                       /\ \__    /\  _`\ /\_ \    __               /\ \__   </span>
<span class="sd">\ \ \L\ \     __      __    ___\ \ ,_\   \ \ \/\_\//\ \  /\_\     __    ___\ \ ,_\  </span>
<span class="sd"> \ \  __ \  /&#39;_ `\  /&#39;__`\/&#39; _ `\ \ \/    \ \ \/_/_\ \ \ \/\ \  /&#39;__`\/&#39; _ `\ \ \/  </span>
<span class="sd">  \ \ \/\ \/\ \L\ \/\  __//\ \/\ \ \ \_    \ \ \L\ \\_\ \_\ \ \/\  __//\ \/\ \ \ \_ </span>
<span class="sd">   \ \_\ \_\ \____ \ \____\ \_\ \_\ \__\    \ \____//\____\\ \_\ \____\ \_\ \_\ \__\</span>
<span class="sd">    \/_/\/_/\/___L\ \/____/\/_/\/_/\/__/     \/___/ \/____/ \/_/\/____/\/_/\/_/\/__/</span>
<span class="sd">              /\____/                                                               </span>
<span class="sd">              \_/__/                                                                                                                      </span>
<span class="sd">--------------------------------------------------------</span>
<span class="sd">&quot;&quot;&quot;</span>

<div class="viewcode-block" id="is_port_in_use"><a class="viewcode-back" href="../agent.html#agent.is_port_in_use">[docs]</a><span class="k">def</span> <span class="nf">is_port_in_use</span><span class="p">(</span><span class="n">port</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">socket</span>
    <span class="k">with</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span> <span class="k">as</span> <span class="n">s</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">s</span><span class="o">.</span><span class="n">connect_ex</span><span class="p">((</span><span class="s1">&#39;localhost&#39;</span><span class="p">,</span> <span class="n">port</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span></div>

<div class="viewcode-block" id="get_next_available_port"><a class="viewcode-back" href="../agent.html#agent.get_next_available_port">[docs]</a><span class="k">def</span> <span class="nf">get_next_available_port</span><span class="p">():</span>
    <span class="n">port</span> <span class="o">=</span> <span class="mi">5555</span>
    <span class="k">while</span> <span class="n">is_port_in_use</span><span class="p">(</span><span class="n">port</span><span class="p">):</span>
        <span class="n">port</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">port</span></div>

<div class="viewcode-block" id="count_number_of_subroutines"><a class="viewcode-back" href="../agent.html#agent.count_number_of_subroutines">[docs]</a><span class="k">def</span> <span class="nf">count_number_of_subroutines</span><span class="p">(</span><span class="n">module</span><span class="p">:</span> <span class="n">Module</span><span class="p">):</span>
        <span class="n">count</span> <span class="o">=</span> <span class="n">module</span><span class="o">.</span><span class="n">NUMBER_OF_TIMED_COROUTINES</span>
        <span class="k">for</span> <span class="n">submodule</span> <span class="ow">in</span> <span class="n">module</span><span class="o">.</span><span class="n">submodules</span><span class="p">:</span>
            <span class="n">count</span> <span class="o">+=</span> <span class="n">count_number_of_subroutines</span><span class="p">(</span><span class="n">submodule</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">count</span></div>

<div class="viewcode-block" id="load_payload"><a class="viewcode-back" href="../agent.html#agent.load_payload">[docs]</a><span class="k">def</span> <span class="nf">load_payload</span><span class="p">(</span><span class="n">scenario_dir</span><span class="p">):</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">scenario_dir</span> <span class="o">+</span><span class="s1">&#39;MissionSpecs.json&#39;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">scenario_specs</span><span class="p">:</span>
        <span class="c1"># load json file as dictionary</span>
        <span class="n">mission_dict</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">scenario_specs</span><span class="p">)</span>

        <span class="n">data</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">spacecraft_list</span> <span class="o">=</span> <span class="n">mission_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;spacecraft&#39;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">spacecraft</span> <span class="ow">in</span> <span class="n">spacecraft_list</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">spacecraft</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">)</span>
            <span class="c1"># land coverage data metrics data</span>
            <span class="n">payload</span> <span class="o">=</span> <span class="n">spacecraft</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;instrument&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="n">data</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">payload</span>
    <span class="k">return</span> <span class="n">data</span></div>

<div class="viewcode-block" id="load_mission_dict"><a class="viewcode-back" href="../agent.html#agent.load_mission_dict">[docs]</a><span class="k">def</span> <span class="nf">load_mission_dict</span><span class="p">(</span><span class="n">scenario_dir</span><span class="p">):</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">scenario_dir</span> <span class="o">+</span><span class="s1">&#39;MissionSpecs.json&#39;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">scenario_specs</span><span class="p">:</span>
        <span class="c1"># load json file as dictionary</span>
        <span class="n">mission_dict</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">scenario_specs</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">mission_dict</span></div>
        
<div class="viewcode-block" id="AgentClient"><a class="viewcode-back" href="../agent.html#agent.AgentClient">[docs]</a><span class="k">class</span> <span class="nc">AgentClient</span><span class="p">(</span><span class="n">NodeModule</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">scenario_dir</span><span class="p">,</span> <span class="n">env_port_number</span> <span class="o">=</span> <span class="s1">&#39;5561&#39;</span><span class="p">,</span> <span class="n">env_request_port_number</span> <span class="o">=</span> <span class="s1">&#39;5562&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># super().__init__(name, submodules=modules, n_timed_coroutines=0)</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">scenario_dir</span><span class="p">,</span> <span class="n">n_timed_coroutines</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                
        <span class="c1"># Network information</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ENVIRONMENT_PORT_NUMBER</span> <span class="o">=</span>  <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">REQUEST_PORT_NUMBER</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">AGENT_TO_PORT_MAP</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">payload</span> <span class="o">=</span> <span class="n">load_payload</span><span class="p">(</span><span class="n">scenario_dir</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mission_dict</span> <span class="o">=</span> <span class="n">load_mission_dict</span><span class="p">(</span><span class="n">scenario_dir</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s1">&#39;Agent Initialized!&#39;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>

<div class="viewcode-block" id="AgentClient.live"><a class="viewcode-back" href="../agent.html#agent.AgentClient.live">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">live</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        MAIN FUNCTION </span>
<span class="sd">        executes event loop for ayncronous processes within the agent</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Activate </span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">activate</span><span class="p">()</span>

        <span class="c1"># Run simulation</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">run</span><span class="p">()</span></div>

<div class="viewcode-block" id="AgentClient.activate"><a class="viewcode-back" href="../agent.html#agent.AgentClient.activate">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">activate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initiates and executes commands that are thread-sensitive but that must be performed before the simulation starts.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Starting activation routine...&#39;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>

        <span class="c1"># initiate network ports and connect to environment server</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s1">&#39;Configuring network ports...&#39;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">network_config</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s1">&#39;Network configuration completed!&#39;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>

        <span class="c1"># confirm online status to environment server </span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;Synchronizing with environment...&quot;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">sync_environment</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Synchronization response received! Synchronized with environment.&#39;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>

        <span class="c1"># await for start-simulation message from environment</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Waiting for simulation start broadcast...&#39;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">wait_sim_start</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Simulation start broadcast received!&#39;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Activating agent submodules...&#39;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>
        <span class="k">await</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">activate</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s1">&#39;Agent activated!&#39;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span></div>

<div class="viewcode-block" id="AgentClient.run"><a class="viewcode-back" href="../agent.html#agent.AgentClient.run">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>        
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Performs simulation actions.</span>

<span class="sd">        Runs every module owned by the agent. Stops when one of the modules goes off-line, completes its run() routines, </span>
<span class="sd">        or the environment sends a simulation end broadcast.</span>
<span class="sd">        &quot;&quot;&quot;</span>  
        <span class="c1"># begin simulation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Starting simulation...&quot;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>
        <span class="k">await</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">run</span><span class="p">()</span></div>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_shut_down</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Terminate processes </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Shutting down agent...&quot;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>
        <span class="n">end_msg</span> <span class="o">=</span> <span class="n">AgentEndConfirmationMessage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">EnvironmentModuleTypes</span><span class="o">.</span><span class="n">ENVIRONMENT_SERVER_NAME</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s1">&#39;Awaiting access to environment request socket...&#39;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">environment_request_lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s1">&#39;Access to environment request socket obtained! Sending agent termination confirmation...&#39;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">environment_request_socket</span><span class="o">.</span><span class="n">send_json</span><span class="p">(</span><span class="n">end_msg</span><span class="o">.</span><span class="n">to_json</span><span class="p">())</span>

        <span class="c1"># self.env_request_logger.info(&#39;Agent termination aknowledgement sent. Awaiting environment response...&#39;)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s1">&#39;Agent termination aknowledgement sent. Awaiting environment response...&#39;</span><span class="p">)</span>

        <span class="c1"># wait for server reply</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">environment_request_socket</span><span class="o">.</span><span class="n">recv</span><span class="p">()</span> 
        <span class="bp">self</span><span class="o">.</span><span class="n">environment_request_lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
        <span class="c1"># self.env_request_logger.info(&#39;Response received! terminating agent.&#39;)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s1">&#39;Response received! terminating agent.&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Closing all network sockets...&quot;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">agent_socket_in</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Closed agent_socket_in&quot;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">agent_socket_out</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Closed agent_socket_out&quot;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">environment_broadcast_socket</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Closed environment_broadcast_socket&quot;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">environment_request_socket</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Closed environment_request_socket&quot;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">term</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Network sockets closed.&quot;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s1">&#39;Processing results...&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">process_results</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s1">&#39;Results processed!&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;...Good Night!&#39;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    --------------------</span>
<span class="sd">    CO-ROUTINES AND TASKS</span>
<span class="sd">    --------------------</span>
<span class="sd">    &quot;&quot;&quot;</span>
<div class="viewcode-block" id="AgentClient.internal_message_handler"><a class="viewcode-back" href="../agent.html#agent.AgentClient.internal_message_handler">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">internal_message_handler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">:</span> <span class="n">InternalMessage</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Handles message intended for this module and performs actions accordingly.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">msg</span><span class="o">.</span><span class="n">dst_module</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">put_in_inbox</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Received internal message with content of type </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">content</span><span class="p">)</span><span class="si">}</span><span class="s1">.&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;No handler specified, dumping message...&#39;</span><span class="p">)</span>

        <span class="k">except</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">CancelledError</span><span class="p">:</span>
            <span class="k">return</span></div>

<div class="viewcode-block" id="AgentClient.coroutines"><a class="viewcode-back" href="../agent.html#agent.AgentClient.coroutines">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">coroutines</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># create coroutine tasks</span>
            <span class="n">coroutines</span> <span class="o">=</span> <span class="p">[]</span>
            
            <span class="n">broadcast_handler</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">broadcast_handler</span><span class="p">())</span>
            <span class="n">broadcast_handler</span><span class="o">.</span><span class="n">set_name</span> <span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">_broadcast_handler&#39;</span><span class="p">)</span>
            <span class="n">coroutines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">broadcast_handler</span><span class="p">)</span>

            <span class="n">_</span><span class="p">,</span> <span class="n">pending</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="n">coroutines</span><span class="p">,</span> <span class="n">return_when</span><span class="o">=</span><span class="n">asyncio</span><span class="o">.</span><span class="n">FIRST_COMPLETED</span><span class="p">)</span>

            <span class="n">done_name</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">for</span> <span class="n">coroutine</span> <span class="ow">in</span> <span class="n">coroutines</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">coroutine</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">pending</span><span class="p">:</span>
                    <span class="n">done_name</span> <span class="o">=</span> <span class="n">coroutine</span><span class="o">.</span><span class="n">get_name</span><span class="p">()</span>

            <span class="c1"># cancell all other coroutine tasks</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">done_name</span><span class="si">}</span><span class="s1"> ended. Terminating all other coroutines...&#39;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">coroutine</span> <span class="ow">in</span> <span class="n">pending</span><span class="p">:</span>
                <span class="n">coroutine</span> <span class="p">:</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Task</span>
                <span class="n">coroutine</span><span class="o">.</span><span class="n">cancel</span><span class="p">()</span>
                <span class="k">await</span> <span class="n">coroutine</span>
            <span class="k">return</span>

        <span class="k">except</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">CancelledError</span><span class="p">:</span> 
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s1">&#39;Cancelling all coroutines...&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">coroutine</span> <span class="ow">in</span> <span class="n">coroutines</span><span class="p">:</span>
                <span class="n">coroutine</span> <span class="p">:</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Task</span>
                <span class="n">coroutine</span><span class="o">.</span><span class="n">cancel</span><span class="p">()</span>
                <span class="k">await</span> <span class="n">coroutine</span>
            <span class="k">return</span></div>

<div class="viewcode-block" id="AgentClient.broadcast_handler"><a class="viewcode-back" href="../agent.html#agent.AgentClient.broadcast_handler">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">broadcast_handler</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Listens for broadcasts from the environment. Stops processes when simulation end-command is received.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">broadcast_json</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">environment_broadcast_socket</span><span class="o">.</span><span class="n">recv_json</span><span class="p">()</span>

                <span class="n">broadcast_dict</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">broadcast_json</span><span class="p">)</span>
                <span class="n">broadcast_type</span> <span class="o">=</span> <span class="n">EnvironmentBroadcastMessageTypes</span><span class="p">[</span><span class="n">broadcast_dict</span><span class="p">[</span><span class="s1">&#39;@type&#39;</span><span class="p">]]</span>
                <span class="n">broadcast_src</span> <span class="o">=</span> <span class="n">broadcast_dict</span><span class="p">[</span><span class="s1">&#39;src&#39;</span><span class="p">]</span>
                <span class="n">broadcast_dst</span> <span class="o">=</span> <span class="n">broadcast_dict</span><span class="p">[</span><span class="s1">&#39;dst&#39;</span><span class="p">]</span>

                <span class="c1"># self.message_logger.info(f&#39;Received broadcast message of type {broadcast_type.name} from {broadcast_src} intended for {broadcast_dst}!&#39;)</span>
                <span class="c1">#self.log(f&#39;Received broadcast message of type {broadcast_type.name} from {broadcast_src} intended for {broadcast_dst}!&#39;)</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">broadcast_dst</span> <span class="ow">or</span> <span class="s1">&#39;all&#39;</span> <span class="o">==</span> <span class="n">broadcast_dst</span><span class="p">:</span>                  
                    <span class="k">if</span> <span class="n">broadcast_type</span> <span class="ow">is</span> <span class="n">EnvironmentBroadcastMessageTypes</span><span class="o">.</span><span class="n">TIC_EVENT</span><span class="p">:</span>
                        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">CLOCK_TYPE</span> <span class="o">==</span> <span class="n">SimClocks</span><span class="o">.</span><span class="n">SERVER_EVENTS</span> 
                            <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">CLOCK_TYPE</span> <span class="o">==</span> <span class="n">SimClocks</span><span class="o">.</span><span class="n">SERVER_TIME</span>
                            <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">CLOCK_TYPE</span> <span class="o">==</span> <span class="n">SimClocks</span><span class="o">.</span><span class="n">SERVER_TIME_FAST</span><span class="p">):</span>
                            
                            <span class="c1"># use server clock broadcasts to update internal clock</span>
                            <span class="n">broadcast</span> <span class="o">=</span> <span class="n">TicEventBroadcast</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">broadcast_dict</span><span class="p">)</span>

                            <span class="c1"># self.message_logger.info(f&#39;Updating internal clock to T={broadcast.t}[s].&#39;)</span>
                            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim_time</span><span class="o">.</span><span class="n">set_level</span><span class="p">(</span><span class="n">broadcast</span><span class="o">.</span><span class="n">t</span><span class="p">)</span>
                            <span class="c1">#self.log(&#39;Updated internal clock.&#39;)</span>

                            <span class="k">continue</span>
                        
                    <span class="k">elif</span> <span class="n">broadcast_type</span> <span class="ow">is</span> <span class="n">EnvironmentBroadcastMessageTypes</span><span class="o">.</span><span class="n">SIM_END_EVENT</span><span class="p">:</span>
                        <span class="c1"># if simulation end broadcast is received, terminate agent.</span>

                        <span class="n">broadcast</span> <span class="o">=</span> <span class="n">SimulationEndBroadcastMessage</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">broadcast_dict</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s1">&#39;Simulation end broadcast received! Terminating agent...&#39;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>

                        <span class="k">return</span>

                    <span class="c1"># elif broadcast_type is BroadcastMessageTypes.ECLIPSE_EVENT:</span>
                    <span class="c1">#     broadcast = EclipseEventBroadcastMessage.from_dict(broadcast_msg)</span>
                    <span class="c1">#     pass</span>

                    <span class="c1"># elif broadcast_type is BroadcastMessageTypes.GP_ACCESS_EVENT:</span>
                    <span class="c1">#     broadcast = GndPntAccessEventBroadcastMessage.from_dict(broadcast_msg)</span>
                    <span class="c1">#     pass</span>

                    <span class="c1"># elif broadcast_type is BroadcastMessageTypes.GS_ACCESS_EVENT:</span>
                    <span class="c1">#     broadcast = GndStnAccessEventBroadcastMessage.from_dict(broadcast_msg)</span>
                    <span class="c1">#     pass</span>

                    <span class="c1"># elif broadcast_type is BroadcastMessageTypes.AGENT_ACCESS_EVENT:</span>
                    <span class="c1">#     broadcast = AgentAccessEventBroadcastMessage.from_dict(broadcast_msg)</span>
                    <span class="c1">#     pass</span>

                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;Broadcasts of type </span><span class="si">{</span><span class="n">broadcast_type</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1"> not yet supported. Discarding message...&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># broadcast was intended for someone else, discarding</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s1">&#39;Broadcast not intended for this agent. Discarding message...&#39;</span><span class="p">)</span>
                    

        <span class="k">except</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">CancelledError</span><span class="p">:</span>
            <span class="k">return</span></div>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    --------------------</span>
<span class="sd">    HELPING FUNCTIONS</span>
<span class="sd">    --------------------    </span>
<span class="sd">    &quot;&quot;&quot;</span>
<div class="viewcode-block" id="AgentClient.network_config"><a class="viewcode-back" href="../agent.html#agent.AgentClient.network_config">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">network_config</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates communication sockets and connects this agent to them.</span>

<span class="sd">        &#39;environment_broadcast_socket&#39;: listens for broadcasts coming from the environment</span>
<span class="sd">        &#39;environment_request_socket&#39;: used to request and receive information directly from the environment</span>
<span class="sd">        &#39;agent_socket_in&#39;: conects to other agents. Receives requests for information from others</span>
<span class="sd">        &#39;agent_socket_out&#39;: connects to other agents. Sends information to others</span>
<span class="sd">        &quot;&quot;&quot;</span> 
        <span class="bp">self</span><span class="o">.</span><span class="n">context</span> <span class="o">=</span> <span class="n">zmq</span><span class="o">.</span><span class="n">asyncio</span><span class="o">.</span><span class="n">Context</span><span class="p">()</span> 

        <span class="c1"># subscribe to environment broadcasting port</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">environment_broadcast_socket</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">zmq</span><span class="o">.</span><span class="n">SUB</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">environment_broadcast_socket</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;tcp://localhost:</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">ENVIRONMENT_PORT_NUMBER</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">environment_broadcast_socket</span><span class="o">.</span><span class="n">setsockopt</span><span class="p">(</span><span class="n">zmq</span><span class="o">.</span><span class="n">SUBSCRIBE</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">environment_broadcast_socket</span><span class="o">.</span><span class="n">setsockopt</span><span class="p">(</span><span class="n">zmq</span><span class="o">.</span><span class="n">LINGER</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        
        <span class="c1"># give environment time to set up</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">())</span>

        <span class="c1"># connect to environment request port</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">environment_request_socket</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">zmq</span><span class="o">.</span><span class="n">REQ</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">environment_request_socket</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;tcp://localhost:</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">REQUEST_PORT_NUMBER</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">environment_request_socket</span><span class="o">.</span><span class="n">setsockopt</span><span class="p">(</span><span class="n">zmq</span><span class="o">.</span><span class="n">LINGER</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">environment_request_lock</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Lock</span><span class="p">()</span>

        <span class="c1"># create agent communication sockets</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">agent_socket_in</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">zmq</span><span class="o">.</span><span class="n">REP</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">agent_port_in</span> <span class="o">=</span> <span class="n">get_next_available_port</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">agent_socket_in</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;tcp://*:</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">agent_port_in</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">agent_socket_in</span><span class="o">.</span><span class="n">setsockopt</span><span class="p">(</span><span class="n">zmq</span><span class="o">.</span><span class="n">LINGER</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">agent_socket_in_lock</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Lock</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">agent_socket_out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">zmq</span><span class="o">.</span><span class="n">REQ</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">agent_socket_out</span><span class="o">.</span><span class="n">setsockopt</span><span class="p">(</span><span class="n">zmq</span><span class="o">.</span><span class="n">LINGER</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">agent_socket_out_lock</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Lock</span><span class="p">()</span></div>

<div class="viewcode-block" id="AgentClient.sync_environment"><a class="viewcode-back" href="../agent.html#agent.AgentClient.sync_environment">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">sync_environment</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Cend a synchronization request to environment server</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s1">&#39;Connection to environment established!&#39;</span><span class="p">)</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">environment_request_lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>

        <span class="n">sync_req</span> <span class="o">=</span> <span class="n">SyncRequestMessage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">EnvironmentModuleTypes</span><span class="o">.</span><span class="n">ENVIRONMENT_SERVER_NAME</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent_port_in</span><span class="p">,</span> <span class="n">count_number_of_subroutines</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">environment_request_socket</span><span class="o">.</span><span class="n">send_json</span><span class="p">(</span><span class="n">sync_req</span><span class="o">.</span><span class="n">to_json</span><span class="p">())</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s1">&#39;Synchronization request sent. Awaiting environment response...&#39;</span><span class="p">)</span>

        <span class="c1"># wait for synchronization reply</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">environment_request_socket</span><span class="o">.</span><span class="n">recv</span><span class="p">()</span>  
        <span class="bp">self</span><span class="o">.</span><span class="n">environment_request_lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span></div>

<div class="viewcode-block" id="AgentClient.wait_sim_start"><a class="viewcode-back" href="../agent.html#agent.AgentClient.wait_sim_start">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">wait_sim_start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Awaits for simulation start message from the environment. </span>
<span class="sd">        This message contains a ledger that maps agent names to ports to be connected to for inter-agent communications. </span>
<span class="sd">        The message also contains information about the clock-type being used in this simulation.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># await for start message </span>
        <span class="c1"># start_msg = await self.environment_broadcast_socket.recv_json()</span>
        <span class="n">start_msg_dict</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">environment_broadcast_socket</span><span class="o">.</span><span class="n">recv_json</span><span class="p">()</span>
        <span class="n">start_msg</span> <span class="o">=</span> <span class="n">SimulationStartBroadcastMessage</span><span class="o">.</span><span class="n">from_json</span><span class="p">(</span><span class="n">start_msg_dict</span><span class="p">)</span>

        <span class="c1"># log simulation start time</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">START_TIME</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>

        <span class="c1"># register agent-to-port map</span>
        <span class="n">port_ledger</span> <span class="o">=</span> <span class="n">start_msg</span><span class="o">.</span><span class="n">port_ledger</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">AGENT_TO_PORT_MAP</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">agent</span> <span class="ow">in</span> <span class="n">port_ledger</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">AGENT_TO_PORT_MAP</span><span class="p">[</span><span class="n">agent</span><span class="p">]</span> <span class="o">=</span> <span class="n">port_ledger</span><span class="p">[</span><span class="n">agent</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Agent to port map received: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">AGENT_TO_PORT_MAP</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="c1"># setup clock information</span>
        <span class="n">clock_info</span> <span class="o">=</span> <span class="n">start_msg</span><span class="o">.</span><span class="n">clock_info</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">CLOCK_TYPE</span> <span class="o">=</span> <span class="n">SimClocks</span><span class="p">[</span><span class="n">clock_info</span><span class="p">[</span><span class="s1">&#39;@type&#39;</span><span class="p">]]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">CLOCK_TYPE</span> <span class="o">==</span> <span class="n">SimClocks</span><span class="o">.</span><span class="n">REAL_TIME</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">CLOCK_TYPE</span> <span class="o">==</span> <span class="n">SimClocks</span><span class="o">.</span><span class="n">REAL_TIME_FAST</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">SIMULATION_FREQUENCY</span> <span class="o">=</span> <span class="n">clock_info</span><span class="p">[</span><span class="s1">&#39;freq&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sim_time</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">SIMULATION_FREQUENCY</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sim_time</span> <span class="o">=</span> <span class="n">Container</span><span class="p">()</span></div>
                
<div class="viewcode-block" id="AgentClient.environment_message_submitter"><a class="viewcode-back" href="../agent.html#agent.AgentClient.environment_message_submitter">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">environment_message_submitter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">:</span> <span class="n">NodeToEnvironmentMessage</span><span class="p">,</span> <span class="n">module_name</span><span class="p">:</span> <span class="nb">str</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">msg_type</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">get_type</span><span class="p">()</span>
            <span class="c1">#self.log(f&#39;Submitting a request of type {msg_type}.&#39;)</span>
            <span class="n">acquired</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">TicRequestMessage</span><span class="p">):</span>
                <span class="c1"># submit request</span>
                <span class="c1">#self.log(f&#39;Sending {msg_type} for t_end={msg.t_req}. Awaiting access to environment request socket...&#39;)</span>
                <span class="n">acquired</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">environment_request_lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
                <span class="c1">#self.log(f&#39;Access to environment request socket confirmed. Sending {msg_type}...&#39;)</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">environment_request_socket</span><span class="o">.</span><span class="n">send_json</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">to_json</span><span class="p">())</span>
                <span class="c1">#self.log(f&#39;{msg_type} sent successfully. Awaiting confirmation...&#39;)</span>

                <span class="c1"># wait for sever reply</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">environment_request_socket</span><span class="o">.</span><span class="n">recv</span><span class="p">()</span>  
                <span class="k">if</span> <span class="n">acquired</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">environment_request_lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
                    <span class="n">acquired</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="c1">#self.log(&#39;Tic request reception confirmation received.&#39;)         </span>
                                
                <span class="n">resp</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">AccessSenseMessage</span><span class="p">):</span> 
                <span class="c1"># submit request</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Sending </span><span class="se">\&#39;</span><span class="s1">Agent Access</span><span class="se">\&#39;</span><span class="s1"> Message (from </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1"> to </span><span class="si">{</span><span class="n">msg</span><span class="o">.</span><span class="n">target</span><span class="si">}</span><span class="s1">) to Environment...&#39;</span><span class="p">,</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>
                <span class="n">acquired</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">environment_request_lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Access to environment request socket confirmed. Sending </span><span class="si">{</span><span class="n">msg_type</span><span class="si">}</span><span class="s1">...&#39;</span><span class="p">,</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">environment_request_socket</span><span class="o">.</span><span class="n">send_json</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">to_json</span><span class="p">())</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">msg_type</span><span class="si">}</span><span class="s1"> sent successfully. Awaiting confirmation...&#39;</span><span class="p">,</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>
                
                <span class="c1"># wait for server reply</span>
                <span class="n">resp_json</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">environment_request_socket</span><span class="o">.</span><span class="n">recv_json</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">acquired</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">environment_request_lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
                    <span class="n">acquired</span> <span class="o">=</span> <span class="kc">None</span>

                <span class="k">if</span> <span class="n">resp_json</span> <span class="o">==</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="nb">dict</span><span class="p">()):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Received Request Response: </span><span class="se">\&#39;</span><span class="s1">None</span><span class="se">\&#39;</span><span class="s1">&#39;</span><span class="p">,</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span> 
                    <span class="k">return</span> <span class="kc">None</span>
                    
                <span class="n">resp</span> <span class="o">=</span> <span class="n">AccessSenseMessage</span><span class="o">.</span><span class="n">from_json</span><span class="p">(</span><span class="n">resp_json</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Received Request Response: </span><span class="se">\&#39;</span><span class="si">{</span><span class="n">resp</span><span class="o">.</span><span class="n">result</span><span class="si">}</span><span class="se">\&#39;</span><span class="s1">&#39;</span><span class="p">)</span>        
            
                <span class="c1"># return resp</span>

            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">AgentSenseMessage</span><span class="p">):</span>
                <span class="c1"># submit request</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Sending </span><span class="se">\&#39;</span><span class="s1">Agent Info Sense</span><span class="se">\&#39;</span><span class="s1"> Message to Environment...&#39;</span><span class="p">,</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>
                <span class="n">acquired</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">environment_request_lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Access to environment request socket confirmed. Sending </span><span class="si">{</span><span class="n">msg_type</span><span class="si">}</span><span class="s1">...&#39;</span><span class="p">,</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">environment_request_socket</span><span class="o">.</span><span class="n">send_json</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">to_json</span><span class="p">())</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">msg_type</span><span class="si">}</span><span class="s1"> sent successfully. Awaiting confirmation...&#39;</span><span class="p">,</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>
                
                <span class="c1"># wait for server reply</span>
                <span class="n">resp_json</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">environment_request_socket</span><span class="o">.</span><span class="n">recv_json</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">acquired</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">environment_request_lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
                    <span class="n">acquired</span> <span class="o">=</span> <span class="kc">None</span>

                <span class="k">if</span> <span class="n">resp_json</span> <span class="o">==</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="nb">dict</span><span class="p">()):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Received Response: </span><span class="se">\&#39;</span><span class="s1">None</span><span class="se">\&#39;</span><span class="s1">&#39;</span><span class="p">,</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span> 
                    <span class="k">return</span> <span class="kc">None</span>
                    
                <span class="n">resp</span> <span class="o">=</span> <span class="n">AgentSenseMessage</span><span class="o">.</span><span class="n">from_json</span><span class="p">(</span><span class="n">resp_json</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Received Response: </span><span class="se">\&#39;</span><span class="si">{</span><span class="p">[</span><span class="n">resp</span><span class="o">.</span><span class="n">pos</span><span class="p">,</span> <span class="n">resp</span><span class="o">.</span><span class="n">vel</span><span class="p">,</span> <span class="n">resp</span><span class="o">.</span><span class="n">eclipse</span><span class="p">]</span><span class="si">}</span><span class="se">\&#39;</span><span class="s1">&#39;</span><span class="p">,</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>        
                
                <span class="c1"># return resp</span>

            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">ObservationSenseMessage</span><span class="p">):</span>
                <span class="c1"># submit request</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Sending </span><span class="se">\&#39;</span><span class="s1">Observation Sense</span><span class="se">\&#39;</span><span class="s1"> Message to Environment...&#39;</span><span class="p">,</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>
                <span class="n">acquired</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">environment_request_lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Access to environment request socket confirmed. Sending </span><span class="si">{</span><span class="n">msg_type</span><span class="si">}</span><span class="s1">...&#39;</span><span class="p">,</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">environment_request_socket</span><span class="o">.</span><span class="n">send_json</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">to_json</span><span class="p">())</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">msg_type</span><span class="si">}</span><span class="s1"> sent successfully. Awaiting confirmation...&#39;</span><span class="p">,</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>
                
                <span class="c1"># wait for server reply</span>
                <span class="n">resp_json</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">environment_request_socket</span><span class="o">.</span><span class="n">recv_json</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">acquired</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">environment_request_lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
                    <span class="n">acquired</span> <span class="o">=</span> <span class="kc">None</span>

                <span class="k">if</span> <span class="n">resp_json</span> <span class="o">==</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="nb">dict</span><span class="p">()):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Received Response: </span><span class="se">\&#39;</span><span class="s1">None</span><span class="se">\&#39;</span><span class="s1">&#39;</span><span class="p">,</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span> 
                    <span class="k">return</span> <span class="kc">None</span>
                    
                <span class="n">resp</span> <span class="o">=</span> <span class="n">ObservationSenseMessage</span><span class="o">.</span><span class="n">from_json</span><span class="p">(</span><span class="n">resp_json</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Received Observation Sense Message&#39;</span><span class="p">,</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>        
                
                <span class="c1"># return resp</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Request of type </span><span class="si">{</span><span class="n">msg_type</span><span class="si">}</span><span class="s1"> not supported by request submitter.&#39;</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;SENT, </span><span class="si">{</span><span class="n">msg</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">logger_type</span><span class="o">=</span><span class="n">LoggerTypes</span><span class="o">.</span><span class="n">AGENT_TO_ENV_MESSAGE</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">resp</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;RECEIVED, </span><span class="si">{</span><span class="n">resp</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">logger_type</span><span class="o">=</span><span class="n">LoggerTypes</span><span class="o">.</span><span class="n">ENV_TO_AGENT_MESSAGE</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">resp</span>

        <span class="k">except</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">CancelledError</span><span class="p">:</span>
            <span class="k">return</span></div>

<div class="viewcode-block" id="AgentClient.message_transmitter"><a class="viewcode-back" href="../agent.html#agent.AgentClient.message_transmitter">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">message_transmitter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">:</span> <span class="n">InterNodeMessage</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;In message transmitter&#39;</span><span class="p">,</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>
            <span class="c1"># reformat message</span>
            <span class="n">msg</span><span class="o">.</span><span class="n">src</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
            <span class="n">msg_json</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">to_json</span><span class="p">()</span>

            <span class="c1"># connect socket to destination </span>
            <span class="n">port</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">AGENT_TO_PORT_MAP</span><span class="p">[</span><span class="n">msg</span><span class="o">.</span><span class="n">dst</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Connecting to agent </span><span class="si">{</span><span class="n">msg</span><span class="o">.</span><span class="n">dst</span><span class="si">}</span><span class="s1"> through port number </span><span class="si">{</span><span class="n">port</span><span class="si">}</span><span class="s1">...&#39;</span><span class="p">,</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">agent_socket_out</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;tcp://localhost:</span><span class="si">{</span><span class="n">port</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Connected to agent </span><span class="si">{</span><span class="n">msg</span><span class="o">.</span><span class="n">dst</span><span class="si">}</span><span class="s1">!&#39;</span><span class="p">,</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>

            <span class="c1"># submit request</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Transmitting a message of type </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span><span class="si">}</span><span class="s1"> (from </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1"> to </span><span class="si">{</span><span class="n">msg</span><span class="o">.</span><span class="n">dst</span><span class="si">}</span><span class="s1">)...&#39;</span><span class="p">,</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent_socket_out_lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Acquired lock.&#39;</span><span class="p">,</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent_socket_out</span><span class="o">.</span><span class="n">send_json</span><span class="p">(</span><span class="n">msg_json</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span><span class="si">}</span><span class="s1"> message sent successfully. Awaiting response...&#39;</span><span class="p">,</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>
                        
            <span class="c1"># wait for server reply</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent_socket_out</span><span class="o">.</span><span class="n">recv_json</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">agent_socket_out_lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Received message reception confirmation!&#39;</span><span class="p">,</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>      

            <span class="c1"># disconnect socket from destination</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Disconnecting from agent </span><span class="si">{</span><span class="n">msg</span><span class="o">.</span><span class="n">dst</span><span class="si">}</span><span class="s1">...&#39;</span><span class="p">,</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">agent_socket_out</span><span class="o">.</span><span class="n">disconnect</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;tcp://localhost:</span><span class="si">{</span><span class="n">port</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Disconnected from agent </span><span class="si">{</span><span class="n">msg</span><span class="o">.</span><span class="n">dst</span><span class="si">}</span><span class="s1">!&#39;</span><span class="p">,</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">CancelledError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;asyncio CancelledError in message_transmitter&#39;</span><span class="p">,</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>
            <span class="k">return</span></div>

<div class="viewcode-block" id="AgentClient.send_blanc_response"><a class="viewcode-back" href="../agent.html#agent.AgentClient.send_blanc_response">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">send_blanc_response</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">blanc</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">blanc_json</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">blanc</span><span class="p">)</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent_socket_out</span><span class="o">.</span><span class="n">send_json</span><span class="p">(</span><span class="n">blanc_json</span><span class="p">)</span></div>

<div class="viewcode-block" id="AgentClient.process_results"><a class="viewcode-back" href="../agent.html#agent.AgentClient.process_results">[docs]</a>    <span class="k">def</span> <span class="nf">process_results</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span></div></div>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">--------------------</span>
<span class="sd">  TESTING AGENTS</span>
<span class="sd">--------------------</span>
<span class="sd">&quot;&quot;&quot;</span>
<div class="viewcode-block" id="TestAgent"><a class="viewcode-back" href="../agent.html#agent.TestAgent">[docs]</a><span class="k">class</span> <span class="nc">TestAgent</span><span class="p">(</span><span class="n">AgentClient</span><span class="p">):</span>    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">scenario_dir</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">scenario_dir</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">submodules</span> <span class="o">=</span> <span class="p">[</span>
                            <span class="n">TestModule</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
                          <span class="p">]</span></div>

<div class="viewcode-block" id="ScienceTestAgent"><a class="viewcode-back" href="../agent.html#agent.ScienceTestAgent">[docs]</a><span class="k">class</span> <span class="nc">ScienceTestAgent</span><span class="p">(</span><span class="n">AgentClient</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">scenario_dir</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">scenario_dir</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">submodules</span> <span class="o">=</span> <span class="p">[</span>
                            <span class="n">ScienceModule</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">scenario_dir</span><span class="p">,</span><span class="kc">False</span><span class="p">),</span>
                            <span class="n">PlanningModule</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">scenario_dir</span><span class="p">),</span>
                            <span class="n">EngineeringModule</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
                          <span class="p">]</span></div>

<div class="viewcode-block" id="IridiumTestAgent"><a class="viewcode-back" href="../agent.html#agent.IridiumTestAgent">[docs]</a><span class="k">class</span> <span class="nc">IridiumTestAgent</span><span class="p">(</span><span class="n">AgentClient</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">scenario_dir</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">scenario_dir</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">submodules</span> <span class="o">=</span> <span class="p">[</span>
                            <span class="n">IridiumEngineeringModule</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
                          <span class="p">]</span></div>

<div class="viewcode-block" id="GroundTestAgent"><a class="viewcode-back" href="../agent.html#agent.GroundTestAgent">[docs]</a><span class="k">class</span> <span class="nc">GroundTestAgent</span><span class="p">(</span><span class="n">AgentClient</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">scenario_dir</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">scenario_dir</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">submodules</span> <span class="o">=</span> <span class="p">[</span>
                            <span class="n">ScienceModule</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">scenario_dir</span><span class="p">,</span><span class="kc">False</span><span class="p">),</span>
                            <span class="n">GroundEngineeringModule</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
                          <span class="p">]</span></div>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">--------------------</span>
<span class="sd">MAIN</span>
<span class="sd">--------------------    </span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Initializing agent...&#39;</span><span class="p">)</span>
    
    <span class="c1">#agent = TestAgent(&#39;Mars1&#39;, &#39;./scenarios/sim_test&#39;)</span>
    <span class="n">agent</span> <span class="o">=</span> <span class="n">ScienceTestAgent</span><span class="p">(</span><span class="s1">&#39;Mars1&#39;</span><span class="p">,</span> <span class="s1">&#39;./scenarios/sim_test/&#39;</span><span class="p">)</span>
    
    <span class="n">asyncio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">agent</span><span class="o">.</span><span class="n">live</span><span class="p">())</span>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../index.html">3D-CHESS</a></h1>








<h3>Navigation</h3>
<p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../modules.html">dmas</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../index.html">Documentation overview</a><ul>
  <li><a href="index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2023, Alan Aguilar Jaramillo, Ben Gorr.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 5.2.2</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
    </div>

    

    
  </body>
</html>