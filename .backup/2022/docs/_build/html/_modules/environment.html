
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>environment &#8212; 3D-CHESS 0 documentation</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/alabaster.css" />
    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/sphinx_highlight.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
   
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for environment</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">asyncio</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">zmq.asyncio</span>

<span class="kn">from</span> <span class="nn">utils</span> <span class="kn">import</span> <span class="n">EnvironmentModuleTypes</span>
<span class="kn">from</span> <span class="nn">orbitdata</span> <span class="kn">import</span> <span class="n">OrbitData</span>

<span class="kn">from</span> <span class="nn">messages</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">modules</span> <span class="kn">import</span>  <span class="o">*</span>
<span class="kn">from</span> <span class="nn">utils</span> <span class="kn">import</span> <span class="n">Container</span><span class="p">,</span> <span class="n">SimClocks</span><span class="p">,</span> <span class="n">EnvironmentModuleTypes</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">base64</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">--------------------------------------------------------</span>
<span class="sd"> ____                                                                         __      </span>
<span class="sd">/\  _`\                    __                                                /\ \__   </span>
<span class="sd">\ \ \L\_\    ___   __  __ /\_\  _ __   ___     ___     ___ ___      __    ___\ \ ,_\  </span>
<span class="sd"> \ \  _\L  /&#39; _ `\/\ \/\ \\/\ \/\`&#39;__\/ __`\ /&#39; _ `\ /&#39; __` __`\  /&#39;__`\/&#39; _ `\ \ \/  </span>
<span class="sd">  \ \ \L\ \/\ \/\ \ \ \_/ |\ \ \ \ \//\ \L\ \/\ \/\ \/\ \/\ \/\ \/\  __//\ \/\ \ \ \_ </span>
<span class="sd">   \ \____/\ \_\ \_\ \___/  \ \_\ \_\\ \____/\ \_\ \_\ \_\ \_\ \_\ \____\ \_\ \_\ \__\</span>
<span class="sd">    \/___/  \/_/\/_/\/__/    \/_/\/_/ \/___/  \/_/\/_/\/_/\/_/\/_/\/____/\/_/\/_/\/__/</span>
<span class="sd">                                                                                      </span>
<span class="sd"> /&#39;\_/`\            /\ \         /\_ \            </span>
<span class="sd">/\      \    ___    \_\ \  __  __\//\ \      __   </span>
<span class="sd">\ \ \__\ \  / __`\  /&#39;_` \/\ \/\ \ \ \ \   /&#39;__`\ </span>
<span class="sd"> \ \ \_/\ \/\ \L\ \/\ \L\ \ \ \_\ \ \_\ \_/\  __/ </span>
<span class="sd">  \ \_\\ \_\ \____/\ \___,_\ \____/ /\____\ \____\</span>
<span class="sd">   \/_/ \/_/\/___/  \/__,_ /\/___/  \/____/\/____/                                                                                                                                                    </span>
<span class="sd">--------------------------------------------------------</span>
<span class="sd">&quot;&quot;&quot;</span>
<div class="viewcode-block" id="TicRequestModule"><a class="viewcode-back" href="../environment.html#environment.TicRequestModule">[docs]</a><span class="k">class</span> <span class="nc">TicRequestModule</span><span class="p">(</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent_environment</span> <span class="p">:</span> <span class="n">Module</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">EnvironmentModuleTypes</span><span class="o">.</span><span class="n">TIC_REQUEST_MODULE</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">parent_environment</span><span class="p">,</span> <span class="n">submodules</span><span class="o">=</span><span class="p">[],</span> <span class="n">n_timed_coroutines</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<div class="viewcode-block" id="TicRequestModule.activate"><a class="viewcode-back" href="../environment.html#environment.TicRequestModule.activate">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">activate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">await</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">activate</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tic_request_queue</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Queue</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tic_request_queue_sorted</span> <span class="o">=</span> <span class="p">[]</span></div>

<div class="viewcode-block" id="TicRequestModule.internal_message_handler"><a class="viewcode-back" href="../environment.html#environment.TicRequestModule.internal_message_handler">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">internal_message_handler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">:</span> <span class="n">InternalMessage</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Handles message intended for this module and performs actions accordingly.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">msg</span><span class="o">.</span><span class="n">dst_module</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
                <span class="c1"># this module is NOT the intended receiver for this message. Forwarding to rightful destination</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">send_internal_message</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">content</span><span class="p">,</span> <span class="n">TicRequestMessage</span><span class="p">):</span>
                    <span class="c1"># if a tic request is received, add to tic_request_queue</span>
                    <span class="n">tic_msg</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">content</span>
                    <span class="n">t</span> <span class="o">=</span> <span class="n">tic_msg</span><span class="o">.</span><span class="n">t_req</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Received tic request for time </span><span class="si">{</span><span class="n">t</span><span class="si">}</span><span class="s1">!&#39;</span><span class="p">)</span>
                    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">tic_request_queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># if not a tic request, dump message</span>
                    <span class="k">return</span>
        <span class="k">except</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">CancelledError</span><span class="p">:</span>
            <span class="k">return</span></div>

<div class="viewcode-block" id="TicRequestModule.coroutines"><a class="viewcode-back" href="../environment.html#environment.TicRequestModule.coroutines">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">coroutines</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">parent_server</span> <span class="p">:</span> <span class="n">EnvironmentServer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent_module</span>
            <span class="n">n_routines</span> <span class="o">=</span> <span class="n">parent_server</span><span class="o">.</span><span class="n">NUMBER_OF_TIMED_COROUTINES_AGENTS</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent_module</span><span class="o">.</span><span class="n">NUMBER_OF_TIMED_COROUTINES</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">wait_task</span> <span class="o">=</span> <span class="kc">None</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">CLOCK_TYPE</span> <span class="ow">is</span> <span class="n">SimClocks</span><span class="o">.</span><span class="n">SERVER_EVENTS</span><span class="p">:</span>
                    <span class="c1"># append tic request to request list</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Waiting for next tic request (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tic_request_queue_sorted</span><span class="p">)</span><span class="si">}</span><span class="s1"> / </span><span class="si">{</span><span class="n">n_routines</span><span class="si">}</span><span class="s1">)...&#39;</span><span class="p">)</span>

                    <span class="n">tic_req</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">tic_request_queue</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">tic_request_queue_sorted</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tic_req</span><span class="p">)</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Tic request received! Queue status: (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tic_request_queue_sorted</span><span class="p">)</span><span class="si">}</span><span class="s1"> / </span><span class="si">{</span><span class="n">n_routines</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
                        
                    <span class="c1"># wait until all timed coroutines from all agents have entered a wait period and have submitted their respective tic requests</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tic_request_queue_sorted</span><span class="p">)</span> <span class="o">==</span> <span class="n">n_routines</span><span class="p">:</span>
                        <span class="c1"># sort requests</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s1">&#39;Sorting tic requests...&#39;</span><span class="p">)</span>
                        <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tic_request_queue_sorted</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">tic_request_queue_sorted</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Tic requests sorted: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">tic_request_queue_sorted</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

                        <span class="c1"># skip time to earliest requested time</span>
                        <span class="n">t_next</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tic_request_queue_sorted</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>

                        <span class="c1"># send a broadcast request to parent environment              </span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Submitting broadcast request for tic with server clock at t=</span><span class="si">{</span><span class="n">t_next</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                        <span class="n">parent_server</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_top_module</span><span class="p">()</span>
                        <span class="n">tic_broadcast</span> <span class="o">=</span> <span class="n">TicEventBroadcast</span><span class="p">(</span><span class="n">parent_server</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">t_next</span><span class="p">)</span>
                        <span class="n">msg_out</span> <span class="o">=</span> <span class="n">InternalMessage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">parent_server</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">tic_broadcast</span><span class="p">)</span>

                        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">send_internal_message</span><span class="p">(</span><span class="n">msg_out</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Server clock is of type </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">CLOCK_TYPE</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s1">. Sleeping for the rest of the simulation...&#39;</span><span class="p">)</span>
                    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                        <span class="n">wait_task</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sim_wait</span><span class="p">(</span><span class="mf">1e6</span><span class="p">))</span>
                        <span class="k">await</span> <span class="n">wait_task</span>

        <span class="k">except</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">CancelledError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Received task cancel command!&#39;</span><span class="p">)</span>
            <span class="k">return</span></div></div>


<div class="viewcode-block" id="ScheduledEventModule"><a class="viewcode-back" href="../environment.html#environment.ScheduledEventModule">[docs]</a><span class="k">class</span> <span class="nc">ScheduledEventModule</span><span class="p">(</span><span class="n">Module</span><span class="p">):</span> 
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    In charge of broadcasting scheduled events to all agents</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="n">EnvironmentModuleTypes</span><span class="p">,</span><span class="n">parent_environment</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>   
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">parent_environment</span><span class="p">,</span> <span class="n">submodules</span><span class="o">=</span><span class="p">[],</span> <span class="n">n_timed_coroutines</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># initialize scheduled events data and sort</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">event_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compile_event_data</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">event_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">event_data</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;time index&#39;</span><span class="p">])</span>

        <span class="c1"># if data does not have proper format, reject</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_data_format</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Event data loaded in an incorrect format.&#39;</span><span class="p">)</span>

        <span class="c1"># get scheduled event time-step</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">time_step</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">parent_env</span> <span class="p">:</span> <span class="n">EnvironmentServer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent_module</span><span class="o">.</span><span class="n">parent_module</span>
        <span class="k">for</span> <span class="n">agent_name</span> <span class="ow">in</span> <span class="n">parent_env</span><span class="o">.</span><span class="n">orbit_data</span><span class="p">:</span>
            <span class="n">orbit_data</span> <span class="p">:</span> <span class="n">OrbitData</span> <span class="o">=</span> <span class="n">parent_env</span><span class="o">.</span><span class="n">orbit_data</span><span class="p">[</span><span class="n">agent_name</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">time_step</span> <span class="o">=</span> <span class="n">orbit_data</span><span class="o">.</span><span class="n">time_step</span>
            <span class="k">break</span>

<div class="viewcode-block" id="ScheduledEventModule.compile_event_data"><a class="viewcode-back" href="../environment.html#environment.ScheduledEventModule.compile_event_data">[docs]</a>    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">compile_event_data</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Loads event data and returns a DataFrame containing information of all scheduled events to be broadcasted</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="ScheduledEventModule.row_to_broadcast_msg"><a class="viewcode-back" href="../environment.html#environment.ScheduledEventModule.row_to_broadcast_msg">[docs]</a>    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">row_to_broadcast_msg</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">row</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">EnvironmentBroadcastMessage</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        converts a row of from &#39;event_data&#39; into a message to be broadcast to other agents</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="ScheduledEventModule.activate"><a class="viewcode-back" href="../environment.html#environment.ScheduledEventModule.activate">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">activate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initiates event scheduling by loading event information</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">await</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">activate</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">event_data</span><span class="p">)</span></div>
    
<div class="viewcode-block" id="ScheduledEventModule.check_data_format"><a class="viewcode-back" href="../environment.html#environment.ScheduledEventModule.check_data_format">[docs]</a>    <span class="k">def</span> <span class="nf">check_data_format</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Verifyes if the &#39;compile_event_data()&#39; method loaded data in the appropriate format.</span>
<span class="sd">        Event must at least specify:</span>
<span class="sd">            -&#39;time index&#39;: when the event occurrs</span>
<span class="sd">            -&#39;agent name&#39;: which agent is affected by said event</span>
<span class="sd">            -&#39;rise&#39;: whether this broadcast would signal the start (True) or the end (False) of an event</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">required_columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;time index&#39;</span><span class="p">,</span> <span class="s1">&#39;agent name&#39;</span><span class="p">,</span> <span class="s1">&#39;rise&#39;</span><span class="p">]</span>
        
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">required_columns</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">event_data</span><span class="o">.</span><span class="n">columns</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">False</span>
        
        <span class="k">for</span> <span class="n">required_column</span> <span class="ow">in</span> <span class="n">required_columns</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">required_column</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">event_data</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>

        <span class="k">return</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="ScheduledEventModule.internal_message_handler"><a class="viewcode-back" href="../environment.html#environment.ScheduledEventModule.internal_message_handler">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">internal_message_handler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">:</span> <span class="n">InternalMessage</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Does not interact with other modules. Any message received will be ignored</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">msg</span><span class="o">.</span><span class="n">dst_module</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">send_internal_message</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># ignores all incoming messages</span>
                <span class="c1"># TODO: allow for this module to be reactive to any changes in the predetermined scheduled events via incoming messages</span>
                <span class="k">return</span>
        <span class="k">except</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">CancelledError</span><span class="p">:</span>
            <span class="k">return</span>    </div>

<div class="viewcode-block" id="ScheduledEventModule.coroutines"><a class="viewcode-back" href="../environment.html#environment.ScheduledEventModule.coroutines">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">coroutines</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parses through event data and sends broadcast requests to parent environment</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">wait_task</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">event_data</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
                <span class="c1"># get next scheduled event message</span>
                <span class="n">event_broadcast</span> <span class="p">:</span> <span class="n">EventBroadcastMessage</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">row_to_broadcast_msg</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>

                <span class="c1"># wait for said event to start</span>
                <span class="n">t_next</span> <span class="o">=</span> <span class="n">event_broadcast</span><span class="o">.</span><span class="n">t</span>
                <span class="n">wait_task</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim_wait</span><span class="p">(</span><span class="n">t_next</span><span class="p">,</span> <span class="n">module_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="p">)</span>
                <span class="k">await</span> <span class="n">wait_task</span>

                <span class="c1"># log broadcast request</span>
                <span class="n">broadcast_type</span> <span class="o">=</span> <span class="n">event_broadcast</span><span class="o">.</span><span class="n">get_type</span><span class="p">()</span>
                <span class="n">agent_name</span> <span class="o">=</span> <span class="n">event_broadcast</span><span class="o">.</span><span class="n">dst</span>

                <span class="k">if</span> <span class="n">event_broadcast</span><span class="o">.</span><span class="n">rise</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Submitting broadcast request for event type </span><span class="si">{</span><span class="n">broadcast_type</span><span class="si">}</span><span class="s1"> START at t=</span><span class="si">{</span><span class="n">t_next</span><span class="si">}</span><span class="s1"> for target </span><span class="se">\&#39;</span><span class="si">{</span><span class="n">agent_name</span><span class="si">}</span><span class="se">\&#39;</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">module_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Submitting broadcast request for event type </span><span class="si">{</span><span class="n">broadcast_type</span><span class="si">}</span><span class="s1"> END at t=</span><span class="si">{</span><span class="n">t_next</span><span class="si">}</span><span class="s1"> for target </span><span class="se">\&#39;</span><span class="si">{</span><span class="n">agent_name</span><span class="si">}</span><span class="se">\&#39;</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">module_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

                <span class="c1"># send a broadcast request to parent environment      </span>
                <span class="n">dst</span> <span class="o">=</span>  <span class="bp">self</span><span class="o">.</span><span class="n">get_top_module</span><span class="p">()</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="n">InternalMessage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">dst</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">event_broadcast</span><span class="p">)</span>            
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">send_internal_message</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Broadcast request successfully submitted!&#39;</span><span class="p">)</span>

            <span class="c1"># once all events have occurred, go to sleep until the end of the simulation</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;All events have occurred! Sleeping until the end of the simulation...&#39;</span><span class="p">)</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">wait_task</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim_wait</span><span class="p">(</span><span class="mf">1e6</span><span class="p">,</span> <span class="n">module_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="p">)</span>
                <span class="k">await</span> <span class="n">wait_task</span>

        <span class="k">except</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">CancelledError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Scheduled event broadcast interrupted!&#39;</span><span class="p">)</span>
            <span class="k">return</span></div></div>

<div class="viewcode-block" id="EclipseEventModule"><a class="viewcode-back" href="../environment.html#environment.EclipseEventModule">[docs]</a><span class="k">class</span> <span class="nc">EclipseEventModule</span><span class="p">(</span><span class="n">ScheduledEventModule</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    In charge of broadcasting eclipse events to all agents</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent_environment</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">EnvironmentModuleTypes</span><span class="o">.</span><span class="n">ECLIPSE_EVENT_MODULE</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">parent_environment</span><span class="p">)</span>

<div class="viewcode-block" id="EclipseEventModule.row_to_broadcast_msg"><a class="viewcode-back" href="../environment.html#environment.EclipseEventModule.row_to_broadcast_msg">[docs]</a>    <span class="k">def</span> <span class="nf">row_to_broadcast_msg</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">row</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">EclipseEventBroadcastMessage</span><span class="p">:</span>
        <span class="n">t_next</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;time index&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_step</span>
        <span class="n">agent_name</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;agent name&#39;</span><span class="p">]</span>
        <span class="n">rise</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;rise&#39;</span><span class="p">]</span>

        <span class="n">src</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_top_module</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">EclipseEventBroadcastMessage</span><span class="p">(</span><span class="n">src</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">agent_name</span><span class="p">,</span> <span class="n">t_next</span><span class="p">,</span> <span class="n">rise</span><span class="p">)</span></div>
        
<div class="viewcode-block" id="EclipseEventModule.compile_event_data"><a class="viewcode-back" href="../environment.html#environment.EclipseEventModule.compile_event_data">[docs]</a>    <span class="k">def</span> <span class="nf">compile_event_data</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="n">orbit_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent_module</span><span class="o">.</span><span class="n">parent_module</span><span class="o">.</span><span class="n">orbit_data</span>
        <span class="n">eclipse_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;time index&#39;</span><span class="p">,</span> <span class="s1">&#39;agent name&#39;</span><span class="p">,</span> <span class="s1">&#39;rise&#39;</span><span class="p">])</span>
        
        <span class="k">for</span> <span class="n">agent</span> <span class="ow">in</span> <span class="n">orbit_data</span><span class="p">:</span>
            <span class="n">agent_eclipse_data</span> <span class="o">=</span> <span class="n">orbit_data</span><span class="p">[</span><span class="n">agent</span><span class="p">]</span><span class="o">.</span><span class="n">eclipse_data</span>
            <span class="n">nrows</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">agent_eclipse_data</span><span class="o">.</span><span class="n">shape</span>
            <span class="n">agent_name_column</span> <span class="o">=</span> <span class="p">[</span><span class="n">agent</span><span class="p">]</span> <span class="o">*</span> <span class="n">nrows</span>

            <span class="n">eclipse_rise</span> <span class="o">=</span> <span class="n">agent_eclipse_data</span><span class="o">.</span><span class="n">get</span><span class="p">([</span><span class="s1">&#39;start index&#39;</span><span class="p">])</span>
            <span class="n">eclipse_rise</span> <span class="o">=</span> <span class="n">eclipse_rise</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;start index&#39;</span><span class="p">:</span> <span class="s1">&#39;time index&#39;</span><span class="p">})</span>
            <span class="n">eclipse_rise</span><span class="p">[</span><span class="s1">&#39;agent name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">agent_name_column</span>
            <span class="n">eclipse_rise</span><span class="p">[</span><span class="s1">&#39;rise&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="kc">True</span><span class="p">]</span> <span class="o">*</span> <span class="n">nrows</span>

            <span class="n">eclipse_set</span> <span class="o">=</span> <span class="n">agent_eclipse_data</span><span class="o">.</span><span class="n">get</span><span class="p">([</span><span class="s1">&#39;end index&#39;</span><span class="p">])</span>
            <span class="n">eclipse_set</span> <span class="o">=</span> <span class="n">eclipse_set</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;end index&#39;</span><span class="p">:</span> <span class="s1">&#39;time index&#39;</span><span class="p">})</span>
            <span class="n">eclipse_set</span><span class="p">[</span><span class="s1">&#39;agent name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">agent_name_column</span>
            <span class="n">eclipse_set</span><span class="p">[</span><span class="s1">&#39;rise&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="kc">False</span><span class="p">]</span> <span class="o">*</span> <span class="n">nrows</span>

            <span class="n">eclipse_merged</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">eclipse_rise</span><span class="p">,</span> <span class="n">eclipse_set</span><span class="p">])</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">eclipse_data</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">eclipse_data</span> <span class="o">=</span> <span class="n">eclipse_merged</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">eclipse_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">eclipse_data</span><span class="p">,</span> <span class="n">eclipse_merged</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">eclipse_data</span></div></div>

<span class="c1"># class ImageServerModule(Module):</span>
<span class="c1">#     &quot;&quot;&quot;</span>
<span class="c1">#     Provides images corresponding to payload view</span>
<span class="c1">#     &quot;&quot;&quot;</span>
<span class="c1">#     def __init__(self, parent_environment) -&gt; None:</span>
<span class="c1">#         super().__init__(EnvironmentModuleTypes.IMAGE_SERVER_MODULE.value, parent_environment, submodules=[], n_timed_coroutines=1)</span>

<span class="c1">#     async def activate(self):</span>
<span class="c1">#         await super().activate()</span>
<span class="c1">#         # self.img_request_queue = []</span>

<span class="c1">#     async def internal_message_handler(self, msg: InternalMessage):</span>
<span class="c1">#         &quot;&quot;&quot;</span>
<span class="c1">#         Handles message intended for this module and performs actions accordingly.</span>
<span class="c1">#         &quot;&quot;&quot;</span>
<span class="c1">#         try:</span>
<span class="c1">#             if msg.dst_module != self.name:</span>
<span class="c1">#                 # this module is NOT the intended receiver for this message. Forwarding to rightful destination</span>
<span class="c1">#                 await self.send_internal_message(msg)</span>
<span class="c1">#             else:</span>
<span class="c1">#                 if isinstance(msg.content, ObservationSenseMessage):</span>
<span class="c1">#                     # if a img request is received, add to img_request_queue</span>
<span class="c1">#                     img_req = msg.content</span>
<span class="c1">#                     lat = img_req.lat</span>
<span class="c1">#                     lon = img_req.lon</span>
<span class="c1">#                     self.log(f&#39;Received measurement result from ({lat}°, {lon}°)!&#39;)</span>
<span class="c1">#                     self.log(f&#39;right before getLandsatFilePath&#39;)</span>
<span class="c1">#                     filepath = getLandsatFilePath(lat,lon)</span>
<span class="c1">#                     img_req.obs = filepath</span>
<span class="c1">#                     img_req.dst = img_req.src</span>
<span class="c1">#                     img_req.src = self.name</span>
<span class="c1">#                     await self.send_internal_message(img_req)</span>
<span class="c1">#                     #await self.reqservice.send_json(img_req.to_json())</span>
<span class="c1">#                     return</span>
<span class="c1">#                 else:</span>
<span class="c1">#                     # if not a tic request, dump message</span>
<span class="c1">#                     return</span>
<span class="c1">#         except asyncio.CancelledError:</span>
<span class="c1">#             return</span>

<div class="viewcode-block" id="GndStatAccessEventModule"><a class="viewcode-back" href="../environment.html#environment.GndStatAccessEventModule">[docs]</a><span class="k">class</span> <span class="nc">GndStatAccessEventModule</span><span class="p">(</span><span class="n">ScheduledEventModule</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent_environment</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">EnvironmentModuleTypes</span><span class="o">.</span><span class="n">GS_ACCESS_EVENT_MODULE</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">parent_environment</span><span class="p">)</span>

<div class="viewcode-block" id="GndStatAccessEventModule.row_to_broadcast_msg"><a class="viewcode-back" href="../environment.html#environment.GndStatAccessEventModule.row_to_broadcast_msg">[docs]</a>    <span class="k">def</span> <span class="nf">row_to_broadcast_msg</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">row</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">GndStnAccessEventBroadcastMessage</span><span class="p">:</span>
        <span class="n">t_next</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;time index&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_step</span>
        <span class="n">agent_name</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;agent name&#39;</span><span class="p">]</span>
        <span class="n">rise</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;rise&#39;</span><span class="p">]</span>
        <span class="n">gndStat_name</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;gndStn name&#39;</span><span class="p">]</span>
        <span class="n">src</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_top_module</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">GndStnAccessEventBroadcastMessage</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">agent_name</span><span class="p">,</span> <span class="n">gndStat_name</span><span class="p">,</span> <span class="n">t_next</span><span class="p">,</span> <span class="n">rise</span><span class="p">)</span></div>

<div class="viewcode-block" id="GndStatAccessEventModule.compile_event_data"><a class="viewcode-back" href="../environment.html#environment.GndStatAccessEventModule.compile_event_data">[docs]</a>    <span class="k">def</span> <span class="nf">compile_event_data</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="n">orbit_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent_module</span><span class="o">.</span><span class="n">parent_module</span><span class="o">.</span><span class="n">orbit_data</span>
        <span class="n">gs_access_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;time index&#39;</span><span class="p">,</span> <span class="s1">&#39;agent name&#39;</span><span class="p">,</span> <span class="s1">&#39;rise&#39;</span><span class="p">,</span> <span class="s1">&#39;gndStn id&#39;</span><span class="p">,</span> <span class="s1">&#39;gndStn name&#39;</span><span class="p">,</span><span class="s1">&#39;lat [deg]&#39;</span><span class="p">,</span><span class="s1">&#39;lon [deg]&#39;</span><span class="p">])</span>

        <span class="k">for</span> <span class="n">agent</span> <span class="ow">in</span> <span class="n">orbit_data</span><span class="p">:</span>
            <span class="n">agent_gs_access_data</span> <span class="o">=</span> <span class="n">orbit_data</span><span class="p">[</span><span class="n">agent</span><span class="p">]</span><span class="o">.</span><span class="n">gs_access_data</span>
            <span class="n">nrows</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">agent_gs_access_data</span><span class="o">.</span><span class="n">shape</span>

            <span class="c1"># rise events</span>
            <span class="n">access_rise</span> <span class="o">=</span> <span class="n">agent_gs_access_data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">access_rise</span> <span class="o">=</span> <span class="n">access_rise</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;start index&#39;</span><span class="p">:</span> <span class="s1">&#39;time index&#39;</span><span class="p">})</span>
            <span class="n">access_rise</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;end index&#39;</span><span class="p">)</span>
            <span class="n">access_rise</span><span class="p">[</span><span class="s1">&#39;agent name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">agent</span><span class="p">]</span> <span class="o">*</span> <span class="n">nrows</span>
            <span class="n">access_rise</span><span class="p">[</span><span class="s1">&#39;rise&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="kc">True</span><span class="p">]</span> <span class="o">*</span> <span class="n">nrows</span>

            <span class="c1"># set events</span>
            <span class="n">access_set</span> <span class="o">=</span> <span class="n">agent_gs_access_data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">access_set</span> <span class="o">=</span> <span class="n">access_set</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;end index&#39;</span><span class="p">:</span> <span class="s1">&#39;time index&#39;</span><span class="p">})</span>
            <span class="n">access_set</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;start index&#39;</span><span class="p">)</span>
            <span class="n">access_set</span><span class="p">[</span><span class="s1">&#39;agent name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">agent</span><span class="p">]</span> <span class="o">*</span> <span class="n">nrows</span>
            <span class="n">access_set</span><span class="p">[</span><span class="s1">&#39;rise&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="kc">False</span><span class="p">]</span> <span class="o">*</span> <span class="n">nrows</span>

            <span class="n">access_merged</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">access_rise</span><span class="p">,</span> <span class="n">access_set</span><span class="p">])</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">gs_access_data</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">gs_access_data</span> <span class="o">=</span> <span class="n">access_merged</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">gs_access_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">gs_access_data</span><span class="p">,</span> <span class="n">access_merged</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">gs_access_data</span></div></div>

<div class="viewcode-block" id="GPAccessEventModule"><a class="viewcode-back" href="../environment.html#environment.GPAccessEventModule">[docs]</a><span class="k">class</span> <span class="nc">GPAccessEventModule</span><span class="p">(</span><span class="n">ScheduledEventModule</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent_environment</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">EnvironmentModuleTypes</span><span class="o">.</span><span class="n">GP_ACCESS_EVENT_MODULE</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">parent_environment</span><span class="p">)</span>

<div class="viewcode-block" id="GPAccessEventModule.row_to_broadcast_msg"><a class="viewcode-back" href="../environment.html#environment.GPAccessEventModule.row_to_broadcast_msg">[docs]</a>    <span class="k">def</span> <span class="nf">row_to_broadcast_msg</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">row</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">GndPntAccessEventBroadcastMessage</span><span class="p">:</span>
        <span class="n">t_next</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;time index&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_step</span>
        <span class="n">agent_name</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;agent name&#39;</span><span class="p">]</span>
        <span class="n">rise</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;rise&#39;</span><span class="p">]</span>
        <span class="n">grid_index</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;grid index&#39;</span><span class="p">]</span>
        <span class="n">gp_index</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;GP index&#39;</span><span class="p">]</span>
        <span class="n">lat</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;lat [deg]&#39;</span><span class="p">]</span>
        <span class="n">lon</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;lon [deg]&#39;</span><span class="p">]</span>
        <span class="n">src</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_top_module</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">GndPntAccessEventBroadcastMessage</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">agent_name</span><span class="p">,</span> <span class="n">lat</span><span class="p">,</span> <span class="n">lon</span><span class="p">,</span> <span class="n">grid_index</span><span class="p">,</span> <span class="n">gp_index</span><span class="p">,</span> <span class="n">t_next</span><span class="p">,</span> <span class="n">rise</span><span class="p">)</span></div>

<div class="viewcode-block" id="GPAccessEventModule.compile_event_data"><a class="viewcode-back" href="../environment.html#environment.GPAccessEventModule.compile_event_data">[docs]</a>    <span class="k">def</span> <span class="nf">compile_event_data</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="n">orbit_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent_module</span><span class="o">.</span><span class="n">parent_module</span><span class="o">.</span><span class="n">orbit_data</span>
        <span class="n">coverage_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;time index&#39;</span><span class="p">,</span> <span class="s1">&#39;agent name&#39;</span><span class="p">,</span> <span class="s1">&#39;rise&#39;</span><span class="p">,</span> <span class="s1">&#39;instrument&#39;</span><span class="p">,</span> <span class="s1">&#39;mode&#39;</span><span class="p">,</span> <span class="s1">&#39;grid index&#39;</span><span class="p">,</span> <span class="s1">&#39;GP index&#39;</span><span class="p">,</span> <span class="s1">&#39;pnt-opt index&#39;</span><span class="p">,</span> <span class="s1">&#39;lat [deg]&#39;</span><span class="p">,</span> <span class="s1">&#39;lon [deg]&#39;</span><span class="p">,])</span>

        <span class="k">for</span> <span class="n">agent</span> <span class="ow">in</span> <span class="n">orbit_data</span><span class="p">:</span>
            <span class="n">agent_gp_coverate_data</span> <span class="o">=</span><span class="n">orbit_data</span><span class="p">[</span><span class="n">agent</span><span class="p">]</span><span class="o">.</span><span class="n">gp_access_data</span>
            <span class="n">grid_data</span> <span class="o">=</span> <span class="n">orbit_data</span><span class="p">[</span><span class="n">agent</span><span class="p">]</span><span class="o">.</span><span class="n">grid_data</span>

            <span class="k">for</span> <span class="n">grid_index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">grid_data</span><span class="p">)):</span>
                <span class="n">grid</span> <span class="o">=</span> <span class="n">grid_data</span><span class="p">[</span><span class="n">grid_index</span><span class="p">]</span>

                <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">grid_point</span> <span class="ow">in</span> <span class="n">grid</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
                    <span class="n">gp_index</span> <span class="o">=</span> <span class="n">grid_point</span><span class="p">[</span><span class="s1">&#39;GP index&#39;</span><span class="p">]</span>

                    <span class="n">gp_data</span> <span class="o">=</span> <span class="n">agent_gp_coverate_data</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s1">&#39;`GP index` == @gp_index &amp; `grid index` == @grid_index&#39;</span><span class="p">)</span>
                    <span class="n">gp_data</span> <span class="o">=</span> <span class="n">gp_data</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;time index&#39;</span><span class="p">])</span>

                    <span class="n">intervals</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">gp_data</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
                        <span class="n">t_index</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;time index&#39;</span><span class="p">]</span>

                        <span class="n">interval_found</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="k">for</span> <span class="n">interval</span> <span class="ow">in</span> <span class="n">intervals</span><span class="p">:</span>
                            <span class="n">i_interval</span> <span class="o">=</span> <span class="n">intervals</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">interval</span><span class="p">)</span>
                            <span class="n">t_start</span><span class="p">,</span> <span class="n">t_end</span> <span class="o">=</span> <span class="n">interval</span>

                            <span class="k">if</span> <span class="n">t_index</span> <span class="o">==</span> <span class="n">t_start</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                                <span class="n">t_start</span> <span class="o">=</span> <span class="n">t_index</span>
                                <span class="n">interval_found</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="k">elif</span> <span class="n">t_index</span> <span class="o">==</span> <span class="n">t_end</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span>
                                <span class="n">t_end</span> <span class="o">=</span> <span class="n">t_index</span>
                                <span class="n">interval_found</span> <span class="o">=</span> <span class="kc">True</span>

                            <span class="k">if</span> <span class="n">interval_found</span><span class="p">:</span>
                                <span class="n">intervals</span><span class="p">[</span><span class="n">i_interval</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">t_start</span><span class="p">,</span> <span class="n">t_end</span><span class="p">]</span>
                                <span class="k">break</span>                                                        

                        <span class="k">if</span> <span class="ow">not</span> <span class="n">interval_found</span><span class="p">:</span>
                            <span class="n">interval</span> <span class="o">=</span> <span class="p">[</span><span class="n">t_index</span><span class="p">,</span> <span class="n">t_index</span><span class="p">]</span>
                            <span class="n">intervals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">interval</span><span class="p">)</span>

                    <span class="k">for</span> <span class="n">interval</span> <span class="ow">in</span> <span class="n">intervals</span><span class="p">:</span>
                        <span class="n">t_rise</span><span class="p">,</span> <span class="n">t_set</span> <span class="o">=</span> <span class="n">interval</span>
                        
                        <span class="n">access_rise</span> <span class="o">=</span> <span class="n">gp_data</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s1">&#39;`time index` == @t_rise&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                        <span class="n">access_rise</span><span class="p">[</span><span class="s1">&#39;rise&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="kc">True</span><span class="p">]</span>

                        <span class="n">access_set</span> <span class="o">=</span> <span class="n">gp_data</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s1">&#39;`time index` == @t_set&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                        <span class="n">access_set</span><span class="p">[</span><span class="s1">&#39;rise&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="kc">False</span><span class="p">]</span>

                        <span class="n">access_merged</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">access_rise</span><span class="p">,</span> <span class="n">access_set</span><span class="p">])</span>

                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">coverage_data</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">coverage_data</span> <span class="o">=</span> <span class="n">access_merged</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">coverage_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">coverage_data</span><span class="p">,</span> <span class="n">access_merged</span><span class="p">])</span>
            
        <span class="k">return</span> <span class="n">coverage_data</span></div></div>

<div class="viewcode-block" id="AgentAccessEventModule"><a class="viewcode-back" href="../environment.html#environment.AgentAccessEventModule">[docs]</a><span class="k">class</span> <span class="nc">AgentAccessEventModule</span><span class="p">(</span><span class="n">ScheduledEventModule</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent_environment</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">EnvironmentModuleTypes</span><span class="o">.</span><span class="n">AGENT_ACCESS_EVENT_MODULE</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">parent_environment</span><span class="p">)</span>

<div class="viewcode-block" id="AgentAccessEventModule.row_to_broadcast_msg"><a class="viewcode-back" href="../environment.html#environment.AgentAccessEventModule.row_to_broadcast_msg">[docs]</a>    <span class="k">def</span> <span class="nf">row_to_broadcast_msg</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">row</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AgentAccessEventBroadcastMessage</span><span class="p">:</span>
        <span class="n">t_next</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;time index&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_step</span>
        <span class="n">agent_name</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;agent name&#39;</span><span class="p">]</span>
        <span class="n">rise</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;rise&#39;</span><span class="p">]</span>
        <span class="n">target</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">]</span>
        <span class="n">src</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_top_module</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">AgentAccessEventBroadcastMessage</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">agent_name</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">t_next</span><span class="p">,</span> <span class="n">rise</span><span class="p">)</span></div>

<div class="viewcode-block" id="AgentAccessEventModule.compile_event_data"><a class="viewcode-back" href="../environment.html#environment.AgentAccessEventModule.compile_event_data">[docs]</a>    <span class="k">def</span> <span class="nf">compile_event_data</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="n">orbit_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent_module</span><span class="o">.</span><span class="n">parent_module</span><span class="o">.</span><span class="n">orbit_data</span>  
        <span class="n">agent_access_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;time index&#39;</span><span class="p">,</span> <span class="s1">&#39;agent name&#39;</span><span class="p">,</span> <span class="s1">&#39;rise&#39;</span><span class="p">,</span> <span class="s1">&#39;target&#39;</span><span class="p">])</span>
        
        <span class="k">for</span> <span class="n">src</span> <span class="ow">in</span> <span class="n">orbit_data</span><span class="p">:</span>
            <span class="n">isl_data</span> <span class="o">=</span> <span class="n">orbit_data</span><span class="p">[</span><span class="n">src</span><span class="p">]</span><span class="o">.</span><span class="n">isl_data</span>
            <span class="k">for</span> <span class="n">dst</span> <span class="ow">in</span> <span class="n">isl_data</span><span class="p">:</span>
                <span class="n">nrows</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">isl_data</span><span class="p">[</span><span class="n">dst</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span>
                
                <span class="c1"># rise data</span>
                <span class="n">access_rise</span> <span class="o">=</span> <span class="n">isl_data</span><span class="p">[</span><span class="n">dst</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">access_rise</span> <span class="o">=</span> <span class="n">access_rise</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;start index&#39;</span><span class="p">:</span> <span class="s1">&#39;time index&#39;</span><span class="p">})</span>
                <span class="n">access_rise</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;end index&#39;</span><span class="p">)</span>
                <span class="n">access_rise</span><span class="p">[</span><span class="s1">&#39;agent name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">src</span><span class="p">]</span> <span class="o">*</span> <span class="n">nrows</span>
                <span class="n">access_rise</span><span class="p">[</span><span class="s1">&#39;rise&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="kc">True</span><span class="p">]</span> <span class="o">*</span> <span class="n">nrows</span>
                <span class="n">access_rise</span><span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">dst</span><span class="p">]</span> <span class="o">*</span> <span class="n">nrows</span>

                <span class="c1"># set data</span>
                <span class="n">access_set</span> <span class="o">=</span> <span class="n">isl_data</span><span class="p">[</span><span class="n">dst</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">access_set</span> <span class="o">=</span> <span class="n">access_set</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;end index&#39;</span><span class="p">:</span> <span class="s1">&#39;time index&#39;</span><span class="p">})</span>
                <span class="n">access_set</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;start index&#39;</span><span class="p">)</span>
                <span class="n">access_set</span><span class="p">[</span><span class="s1">&#39;agent name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">src</span><span class="p">]</span> <span class="o">*</span> <span class="n">nrows</span>
                <span class="n">access_set</span><span class="p">[</span><span class="s1">&#39;rise&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="kc">False</span><span class="p">]</span> <span class="o">*</span> <span class="n">nrows</span>
                <span class="n">access_set</span><span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">dst</span><span class="p">]</span> <span class="o">*</span> <span class="n">nrows</span>

                <span class="n">access_merged</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">access_rise</span><span class="p">,</span> <span class="n">access_set</span><span class="p">])</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">agent_access_data</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">agent_access_data</span> <span class="o">=</span> <span class="n">access_merged</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">agent_access_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">agent_access_data</span><span class="p">,</span> <span class="n">access_merged</span><span class="p">])</span>
        
        <span class="k">return</span> <span class="n">agent_access_data</span></div></div>

<div class="viewcode-block" id="AgentExternalStatePropagator"><a class="viewcode-back" href="../environment.html#environment.AgentExternalStatePropagator">[docs]</a><span class="k">class</span> <span class="nc">AgentExternalStatePropagator</span><span class="p">(</span><span class="n">Module</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Module in charge of propagating the external state of the agents present in this simulated scenario</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent_module</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">EnvironmentModuleTypes</span><span class="o">.</span><span class="n">AGENT_EXTERNAL_PROPAGATOR_MODULE</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> 
                            <span class="n">parent_module</span><span class="p">,</span> 
                            <span class="n">submodules</span><span class="o">=</span><span class="p">[],</span> 
                            <span class="n">n_timed_coroutines</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">submodules</span> <span class="o">=</span> <span class="p">[</span>
                            <span class="n">EclipseEventModule</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span> 
                            <span class="n">GPAccessEventModule</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span>
                            <span class="n">GndStatAccessEventModule</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span>
                            <span class="n">AgentAccessEventModule</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
                        <span class="p">]</span></div>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">--------------------------------------------------------</span>
<span class="sd"> ____                                                                         __      </span>
<span class="sd">/\  _`\                    __                                                /\ \__   </span>
<span class="sd">\ \ \L\_\    ___   __  __ /\_\  _ __   ___     ___     ___ ___      __    ___\ \ ,_\  </span>
<span class="sd"> \ \  _\L  /&#39; _ `\/\ \/\ \\/\ \/\`&#39;__\/ __`\ /&#39; _ `\ /&#39; __` __`\  /&#39;__`\/&#39; _ `\ \ \/  </span>
<span class="sd">  \ \ \L\ \/\ \/\ \ \ \_/ |\ \ \ \ \//\ \L\ \/\ \/\ \/\ \/\ \/\ \/\  __//\ \/\ \ \ \_ </span>
<span class="sd">   \ \____/\ \_\ \_\ \___/  \ \_\ \_\\ \____/\ \_\ \_\ \_\ \_\ \_\ \____\ \_\ \_\ \__\</span>
<span class="sd">    \/___/  \/_/\/_/\/__/    \/_/\/_/ \/___/  \/_/\/_/\/_/\/_/\/_/\/____/\/_/\/_/\/__/                                                         </span>
<span class="sd"> ____                                           </span>
<span class="sd">/\  _`\                                         </span>
<span class="sd">\ \,\L\_\     __   _ __   __  __     __   _ __  </span>
<span class="sd"> \/_\__ \   /&#39;__`\/\`&#39;__\/\ \/\ \  /&#39;__`\/\`&#39;__\</span>
<span class="sd">   /\ \L\ \/\  __/\ \ \/ \ \ \_/ |/\  __/\ \ \/ </span>
<span class="sd">   \ `\____\ \____\\ \_\  \ \___/ \ \____\\ \_\ </span>
<span class="sd">    \/_____/\/____/ \/_/   \/__/   \/____/ \/_/                                                                                                                                                   </span>
<span class="sd">--------------------------------------------------------</span>
<span class="sd">&quot;&quot;&quot;</span>

<div class="viewcode-block" id="count_number_of_subroutines"><a class="viewcode-back" href="../environment.html#environment.count_number_of_subroutines">[docs]</a><span class="k">def</span> <span class="nf">count_number_of_subroutines</span><span class="p">(</span><span class="n">module</span><span class="p">:</span> <span class="n">Module</span><span class="p">):</span>
    <span class="n">count</span> <span class="o">=</span> <span class="n">module</span><span class="o">.</span><span class="n">NUMBER_OF_TIMED_COROUTINES</span>
    <span class="k">for</span> <span class="n">submodule</span> <span class="ow">in</span> <span class="n">module</span><span class="o">.</span><span class="n">submodules</span><span class="p">:</span>
        <span class="n">count</span> <span class="o">+=</span> <span class="n">count_number_of_subroutines</span><span class="p">(</span><span class="n">submodule</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">count</span></div>

<div class="viewcode-block" id="is_port_in_use"><a class="viewcode-back" href="../environment.html#environment.is_port_in_use">[docs]</a><span class="k">def</span> <span class="nf">is_port_in_use</span><span class="p">(</span><span class="n">port</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">socket</span>
    <span class="k">with</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span> <span class="k">as</span> <span class="n">s</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">s</span><span class="o">.</span><span class="n">connect_ex</span><span class="p">((</span><span class="s1">&#39;localhost&#39;</span><span class="p">,</span> <span class="n">port</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span></div>

<div class="viewcode-block" id="EnvironmentServer"><a class="viewcode-back" href="../environment.html#environment.EnvironmentServer">[docs]</a><span class="k">class</span> <span class="nc">EnvironmentServer</span><span class="p">(</span><span class="n">NodeModule</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Server encompasing all environment processes. Main module regulates simulation start and end as well as managing network ledgers for all agents to communicate with eachother.</span>
<span class="sd">    Submodules manage the environment clock and the scenario simulation. The latter concerns propagating the state of the environment as a function of time as well as propagating</span>
<span class="sd">    the external states of the agents. </span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scenario_dir</span><span class="p">,</span> <span class="n">agent_name_list</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="n">duration</span><span class="p">,</span> <span class="n">clock_type</span><span class="p">:</span> <span class="n">SimClocks</span> <span class="o">=</span> <span class="n">SimClocks</span><span class="o">.</span><span class="n">REAL_TIME</span><span class="p">,</span> <span class="n">simulation_frequency</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># super().__init__(EnvironmentModuleTypes.ENVIRONMENT_SERVER_NAME.value, n_timed_coroutines=1)</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">EnvironmentModuleTypes</span><span class="o">.</span><span class="n">ENVIRONMENT_SERVER_NAME</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">scenario_dir</span><span class="p">,</span> <span class="n">n_timed_coroutines</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Constants</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">AGENT_NAME_LIST</span> <span class="o">=</span> <span class="p">[]</span>                                       <span class="c1"># List of names of agent present in the simulation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">NUMBER_AGENTS</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">agent_name_list</span><span class="p">)</span>                       <span class="c1"># Number of agents present in the simulation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">NUMBER_OF_TIMED_COROUTINES_AGENTS</span> <span class="o">=</span> <span class="mi">0</span>                      <span class="c1"># Number of timed co-routines to be performed by other agents</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scenario_dir</span> <span class="o">=</span> <span class="n">scenario_dir</span>

        <span class="k">for</span> <span class="n">agent_name</span> <span class="ow">in</span> <span class="n">agent_name_list</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">AGENT_NAME_LIST</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">agent_name</span><span class="p">)</span>

        <span class="c1"># simulation start and end tracking lists</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alive_subscribers</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">offline_subscribers</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># simulation clock constants</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">CLOCK_TYPE</span> <span class="o">=</span> <span class="n">clock_type</span>                                    <span class="c1"># Clock type being used in this simulation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">DURATION</span> <span class="o">=</span> <span class="n">duration</span>                                        <span class="c1"># Duration of simulation in simulation-time</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">SIMULATION_FREQUENCY</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">CLOCK_TYPE</span> <span class="o">==</span> <span class="n">SimClocks</span><span class="o">.</span><span class="n">REAL_TIME</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">SIMULATION_FREQUENCY</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">CLOCK_TYPE</span> <span class="o">==</span> <span class="n">SimClocks</span><span class="o">.</span><span class="n">REAL_TIME_FAST</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">SIMULATION_FREQUENCY</span> <span class="o">=</span> <span class="n">simulation_frequency</span>            <span class="c1"># Ratio of simulation-time seconds to real-time seconds</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">CLOCK_TYPE</span> <span class="o">!=</span> <span class="n">SimClocks</span><span class="o">.</span><span class="n">SERVER_EVENTS</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Simulation clock of type </span><span class="si">{</span><span class="n">clock_type</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s1"> not yet supported&#39;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">simulation_frequency</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">CLOCK_TYPE</span> <span class="o">==</span> <span class="n">SimClocks</span><span class="o">.</span><span class="n">REAL_TIME_FAST</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Simulation frequency needed to initiate simulation with a REAL_TIME_FAST clock.&#39;</span><span class="p">)</span>

        <span class="c1"># propagate orbit and coverage information</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">orbit_data</span> <span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="n">OrbitData</span><span class="o">.</span><span class="n">from_directory</span><span class="p">(</span><span class="n">scenario_dir</span><span class="p">)</span>

        <span class="c1"># set up submodules</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">submodules</span> <span class="o">=</span> <span class="p">[</span> 
                            <span class="n">TicRequestModule</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span>
                            <span class="n">AgentExternalStatePropagator</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
                            <span class="c1">#ImageServerModule(self)</span>
                          <span class="p">]</span>
        
        <span class="c1"># # set up results dir</span>
        <span class="c1"># self.SCENARIO_RESULTS_DIR, self.ENVIRONMENT_RESULTS_DIR = self.EnvironmentModuleTypes.ENVIRONMENT_SERVER_NAME.value(scenario_dir)</span>

        <span class="c1"># # set up loggers</span>
        <span class="c1"># [self.message_logger, self.request_logger, self.state_logger, self.actions_logger] = self.set_up_loggers()</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Environment Initialized!&#39;</span><span class="p">)</span>

<div class="viewcode-block" id="EnvironmentServer.live"><a class="viewcode-back" href="../environment.html#environment.EnvironmentServer.live">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">live</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        MAIN FUNCTION </span>
<span class="sd">        executes event loop for ayncronous processes within the environment</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Activate </span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">activate</span><span class="p">()</span>

        <span class="c1"># Run simulation</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">run</span><span class="p">()</span></div>

<div class="viewcode-block" id="EnvironmentServer.activate"><a class="viewcode-back" href="../environment.html#environment.EnvironmentServer.activate">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">activate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initiates and executes commands that are thread-sensitive but that must be performed before the simulation starts.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s1">&#39;Starting activation routine...&#39;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>
        
        <span class="c1"># activate network ports</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s1">&#39;Configuring network ports...&#39;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">network_config</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s1">&#39;Network configuration completed!&#39;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>

        <span class="c1"># Wait for agents to initialize their own network ports</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Waiting for </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">NUMBER_AGENTS</span><span class="si">}</span><span class="s2"> to initiate...&quot;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>
        <span class="n">subscriber_to_port_map</span> <span class="o">=</span><span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">sync_agents</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;All subscribers initalized! Starting simulation...&quot;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>
        
        <span class="c1"># broadcasting simulation start</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">broadcast_sim_start</span><span class="p">(</span><span class="n">subscriber_to_port_map</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Activating environment submodules...&#39;</span><span class="p">)</span>
        <span class="k">await</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">activate</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s1">&#39;Environment Activated!&#39;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span></div>
    
<div class="viewcode-block" id="EnvironmentServer.run"><a class="viewcode-back" href="../environment.html#environment.EnvironmentServer.run">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>        
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Performs simulation actions.</span>

<span class="sd">        Runs every module owned by the agent. Stops when one of the modules goes off-line, completes its run() routines, </span>
<span class="sd">        or the environment sends a simulation end broadcast.</span>
<span class="sd">        &quot;&quot;&quot;</span>  
        <span class="c1"># begin simulation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Starting simulation...&quot;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>
        <span class="k">await</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">run</span><span class="p">()</span></div>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_shut_down</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Terminate processes </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Shutting down...&quot;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>

        <span class="c1"># broadcast simulation end</span>
        <span class="c1"># await asyncio.sleep(random.random())</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">broadcast_sim_end</span><span class="p">()</span>

        <span class="c1"># close network ports  </span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Closing all network sockets...&quot;</span><span class="p">)</span> 
        <span class="bp">self</span><span class="o">.</span><span class="n">publisher</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reqservice</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">term</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Network sockets closed.&quot;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Simulation done, good night!&quot;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    --------------------</span>
<span class="sd">    CO-ROUTINES AND TASKS</span>
<span class="sd">    --------------------</span>
<span class="sd">    &quot;&quot;&quot;</span>
<div class="viewcode-block" id="EnvironmentServer.coroutines"><a class="viewcode-back" href="../environment.html#environment.EnvironmentServer.coroutines">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">coroutines</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Executes list of coroutine tasks to be excuted by the environment. These coroutine task incluide:</span>
<span class="sd">            1- &#39;sim_end_timer&#39;: simulation timer that counts down to the end of the simulation</span>
<span class="sd">            2- &#39;request_handler&#39;: listens to &#39;reqservice&#39; port and handles agent requests being sent</span>
<span class="sd">            3- &#39;broadcast_handler&#39;: receives broadcast requests and publishes them to all agents</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">sim_end_timer</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sim_wait</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">DURATION</span><span class="p">))</span>
        <span class="n">sim_end_timer</span><span class="o">.</span><span class="n">set_name</span><span class="p">(</span><span class="s1">&#39;sim_timer&#39;</span><span class="p">)</span>
        <span class="n">request_handler</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request_handler</span><span class="p">())</span>
        <span class="n">request_handler</span><span class="o">.</span><span class="n">set_name</span><span class="p">(</span><span class="s1">&#39;req_handler&#39;</span><span class="p">)</span>
        <span class="n">broadcast_handler</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">broadcast_handler</span><span class="p">())</span>
        <span class="n">broadcast_handler</span><span class="o">.</span><span class="n">set_name</span><span class="p">(</span><span class="s1">&#39;broadast_handler&#39;</span><span class="p">)</span>
        <span class="n">routines</span> <span class="o">=</span> <span class="p">[</span><span class="n">sim_end_timer</span><span class="p">,</span> <span class="n">request_handler</span><span class="p">,</span> <span class="n">broadcast_handler</span><span class="p">]</span>

        <span class="n">_</span><span class="p">,</span> <span class="n">pending</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="n">routines</span><span class="p">,</span> <span class="n">return_when</span><span class="o">=</span><span class="n">asyncio</span><span class="o">.</span><span class="n">FIRST_COMPLETED</span><span class="p">)</span>

        <span class="n">done_name</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">coroutine</span> <span class="ow">in</span> <span class="n">routines</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">coroutine</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">pending</span><span class="p">:</span>
                <span class="n">done_name</span> <span class="o">=</span> <span class="n">coroutine</span><span class="o">.</span><span class="n">get_name</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">done_name</span><span class="si">}</span><span class="s2"> completed!&quot;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">pending</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Terminating </span><span class="si">{</span><span class="n">p</span><span class="o">.</span><span class="n">get_name</span><span class="p">()</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>
            <span class="n">p</span><span class="o">.</span><span class="n">cancel</span><span class="p">()</span>
            <span class="k">await</span> <span class="n">p</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Simulation time completed!&quot;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span></div>

<div class="viewcode-block" id="EnvironmentServer.internal_message_handler"><a class="viewcode-back" href="../environment.html#environment.EnvironmentServer.internal_message_handler">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">internal_message_handler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">:</span> <span class="n">InternalMessage</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Handles messages sent from other internal modules intended for this environment and performs actions accordingly.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">msg</span><span class="o">.</span><span class="n">dst_module</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Message not intended for this module. Rerouting.&#39;</span><span class="p">)</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">send_internal_message</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">content</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">content</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">content</span><span class="p">,</span> <span class="n">EnvironmentBroadcastMessage</span><span class="p">):</span>
                    <span class="c1"># if the message is of type broadcast, send to broadcast handler</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Submitting message of type </span><span class="si">{</span><span class="n">content</span><span class="o">.</span><span class="n">get_type</span><span class="p">()</span><span class="si">}</span><span class="s1"> for publishing...&#39;</span><span class="p">)</span>
                    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">publisher_queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>

                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">content</span><span class="p">,</span> <span class="n">TicRequestMessage</span><span class="p">):</span>
                    <span class="c1"># if an submodule sends a tic request, forward to tic request submodule</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Forwarding Tic request to relevant submodule...&#39;</span><span class="p">)</span>
                    <span class="n">msg</span><span class="o">.</span><span class="n">dst_module</span> <span class="o">=</span> <span class="n">EnvironmentModuleTypes</span><span class="o">.</span><span class="n">TIC_REQUEST_MODULE</span><span class="o">.</span><span class="n">name</span>
                    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">send_internal_message</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

                <span class="c1"># elif isinstance(content, ImgRequestMessage):</span>
                <span class="c1">#     # if an submodule sends a img request, forward to img request submodule</span>
                <span class="c1">#     self.log(f&#39;Forwarding image request to relevant submodule...&#39;)</span>
                <span class="c1">#     msg.dst_module = EnvironmentModuleTypes.IMAGE_SERVER_MODULE.name</span>
                <span class="c1">#     await self.send_internal_message(msg)</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># if content type is none of the above, then discard message</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Internal message of type </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">content</span><span class="p">)</span><span class="si">}</span><span class="s1"> not yet supported. Dumping message...&#39;</span><span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Done handling message.&#39;</span><span class="p">)</span>
                <span class="k">return</span>
        <span class="k">except</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">CancelledError</span><span class="p">:</span>
            <span class="k">return</span></div>

<div class="viewcode-block" id="EnvironmentServer.request_handler"><a class="viewcode-back" href="../environment.html#environment.EnvironmentServer.request_handler">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">request_handler</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Listens to &#39;reqservice&#39; socket for any icoming messages being sent by agents to the environment asking for information.</span>
<span class="sd">        List of supported messages:</span>
<span class="sd">            1- tic_request: agents ask to be notified when a certain time has passed in the environment&#39;s clock    </span>
<span class="sd">            2- agent_access_sense: agent asks the enviroment if the agent is capable of accessing another agent at the current simulation time</span>
<span class="sd">            3- gp_access_sense: agent asks the enviroment if the agent is capable of accessing a ground point at the current simulation time</span>
<span class="sd">            4- gs_access_sense: agent asks the enviroment if the agent is capable of accessing a ground station at the current simulation time</span>
<span class="sd">            5- agent_information_sense: agent asks for information regarding its current position, velocity, and eclipse at the current simulation time</span>
<span class="sd">            6- observation_sense: agent requests environment information regarding a the state of a ground point at the current simulation time</span>
<span class="sd">            7- agent_end_confirmation: agent notifies the environment that it has successfully terminated its operations</span>

<span class="sd">        Only tic request create future broadcast tasks. The rest require an immediate response from the environment.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">async</span> <span class="k">def</span> <span class="nf">message_worker</span><span class="p">(</span><span class="n">d</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Handles responses according to the type of message being received from other nodes.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="k">try</span><span class="p">:</span>        
                <span class="c1"># unpackage message type and handle accordingly </span>
                <span class="n">msg_type</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;@type&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">msg_type</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="c1"># if message does not contain an explisit type, dump and ignore message</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Invalid message received through agent message port. Dumping message.&#39;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">reqservice</span><span class="o">.</span><span class="n">send_string</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
                    <span class="k">return</span>

                <span class="k">if</span> <span class="n">NodeToEnvironmentMessageTypes</span><span class="p">[</span><span class="n">msg_type</span><span class="p">]</span> <span class="ow">is</span> <span class="n">NodeToEnvironmentMessageTypes</span><span class="o">.</span><span class="n">TIC_REQUEST</span><span class="p">:</span>
                    <span class="c1"># load tic request</span>
                    <span class="n">request</span> <span class="o">=</span> <span class="n">TicRequestMessage</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">F</span><span class="s1">&#39;RECEIVED, </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">request</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">logger_type</span><span class="o">=</span><span class="n">LoggerTypes</span><span class="o">.</span><span class="n">AGENT_TO_ENV_MESSAGE</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>

                    <span class="c1"># send reception confirmation to agent</span>
                    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">send_blanc_response</span><span class="p">()</span>

                    <span class="c1"># schedule tic request</span>
                    <span class="n">t_req</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">t_req</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Received tic request from </span><span class="si">{</span><span class="n">request</span><span class="o">.</span><span class="n">src</span><span class="si">}</span><span class="s1"> for t_req=</span><span class="si">{</span><span class="n">t_req</span><span class="si">}</span><span class="s1">!&#39;</span><span class="p">)</span>

                    <span class="c1"># send to internal message router for forwarding</span>
                    <span class="n">tic_req</span> <span class="o">=</span> <span class="n">InternalMessage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">EnvironmentModuleTypes</span><span class="o">.</span><span class="n">TIC_REQUEST_MODULE</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">request</span><span class="p">)</span>
                    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">send_internal_message</span><span class="p">(</span><span class="n">tic_req</span><span class="p">)</span>

                    <span class="n">resp_msg</span> <span class="o">=</span> <span class="kc">None</span>

                <span class="k">elif</span> <span class="n">NodeToEnvironmentMessageTypes</span><span class="p">[</span><span class="n">msg_type</span><span class="p">]</span> <span class="ow">is</span> <span class="n">NodeToEnvironmentMessageTypes</span><span class="o">.</span><span class="n">AGENT_ACCESS_SENSE</span><span class="p">:</span>
                    <span class="c1"># unpackage message</span>
                    <span class="n">agent_access_msg</span> <span class="o">=</span> <span class="n">AgentAccessSenseMessage</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">F</span><span class="s1">&#39;RECEIVED, </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">agent_access_msg</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">logger_type</span><span class="o">=</span><span class="n">LoggerTypes</span><span class="o">.</span><span class="n">AGENT_TO_ENV_MESSAGE</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>
                    
                    <span class="n">t_curr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_current_time</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Received agent access sense message from </span><span class="si">{</span><span class="n">agent_access_msg</span><span class="o">.</span><span class="n">src</span><span class="si">}</span><span class="s1"> to </span><span class="si">{</span><span class="n">agent_access_msg</span><span class="o">.</span><span class="n">target</span><span class="si">}</span><span class="s1"> at simulation time t=</span><span class="si">{</span><span class="n">t_curr</span><span class="si">}</span><span class="s1">!&#39;</span><span class="p">)</span>

                    <span class="c1"># query agent access database</span>
                    <span class="n">is_accessing</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">orbit_data</span><span class="p">[</span><span class="n">agent_access_msg</span><span class="o">.</span><span class="n">src</span><span class="p">]</span><span class="o">.</span><span class="n">is_accessing_agent</span><span class="p">(</span><span class="n">agent_access_msg</span><span class="o">.</span><span class="n">target</span><span class="p">,</span> <span class="n">t_curr</span><span class="p">)</span>
                    <span class="n">agent_access_msg</span><span class="o">.</span><span class="n">set_result</span><span class="p">(</span><span class="n">is_accessing</span><span class="p">)</span>
                    <span class="k">if</span><span class="p">(</span><span class="n">agent_access_msg</span><span class="o">.</span><span class="n">src</span> <span class="o">==</span> <span class="s2">&quot;Iridium&quot;</span> <span class="ow">or</span> <span class="n">agent_access_msg</span><span class="o">.</span><span class="n">target</span> <span class="o">==</span> <span class="s2">&quot;Iridium&quot;</span><span class="p">):</span>
                        <span class="n">agent_access_msg</span><span class="o">.</span><span class="n">set_result</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
                    
                    <span class="c1"># change source and destination for response message</span>
                    <span class="n">agent_access_msg</span><span class="o">.</span><span class="n">dst</span> <span class="o">=</span> <span class="n">agent_access_msg</span><span class="o">.</span><span class="n">src</span>
                    <span class="n">agent_access_msg</span><span class="o">.</span><span class="n">src</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
                    
                    <span class="c1"># send response to agent</span>
                    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">reqservice</span><span class="o">.</span><span class="n">send_json</span><span class="p">(</span><span class="n">agent_access_msg</span><span class="o">.</span><span class="n">to_json</span><span class="p">())</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Aagent access from </span><span class="si">{</span><span class="n">agent_access_msg</span><span class="o">.</span><span class="n">src</span><span class="si">}</span><span class="s1"> to </span><span class="si">{</span><span class="n">agent_access_msg</span><span class="o">.</span><span class="n">target</span><span class="si">}</span><span class="s1"> at simulation time t=</span><span class="si">{</span><span class="n">t_curr</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="n">is_accessing</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

                    <span class="n">resp_msg</span> <span class="o">=</span> <span class="n">agent_access_msg</span>

                <span class="k">elif</span> <span class="n">NodeToEnvironmentMessageTypes</span><span class="p">[</span><span class="n">msg_type</span><span class="p">]</span> <span class="ow">is</span> <span class="n">NodeToEnvironmentMessageTypes</span><span class="o">.</span><span class="n">GS_ACCESS_SENSE</span><span class="p">:</span>
                    <span class="c1"># unpackage message</span>
                    <span class="n">gs_access_msg</span> <span class="o">=</span> <span class="n">GndStnAccessSenseMessage</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">F</span><span class="s1">&#39;RECEIVED, </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">gs_access_msg</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">logger_type</span><span class="o">=</span><span class="n">LoggerTypes</span><span class="o">.</span><span class="n">AGENT_TO_ENV_MESSAGE</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>

                    <span class="n">t_curr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_current_time</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Received ground station access sense message from </span><span class="si">{</span><span class="n">gs_access_msg</span><span class="o">.</span><span class="n">src</span><span class="si">}</span><span class="s1"> to </span><span class="si">{</span><span class="n">gs_access_msg</span><span class="o">.</span><span class="n">target</span><span class="si">}</span><span class="s1"> at simulation time t=</span><span class="si">{</span><span class="n">t_curr</span><span class="si">}</span><span class="s1">!&#39;</span><span class="p">)</span>

                    <span class="c1"># query ground point access database</span>
                    <span class="n">is_accessing</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">orbit_data</span><span class="p">[</span><span class="n">gs_access_msg</span><span class="o">.</span><span class="n">src</span><span class="p">]</span><span class="o">.</span><span class="n">is_accessing_ground_station</span><span class="p">(</span><span class="n">gs_access_msg</span><span class="o">.</span><span class="n">target</span><span class="p">,</span> <span class="n">t_curr</span><span class="p">)</span> 
                    <span class="n">gs_access_msg</span><span class="o">.</span><span class="n">set_result</span><span class="p">(</span><span class="n">is_accessing</span><span class="p">)</span>
                    
                    <span class="c1"># change source and destination for response message</span>
                    <span class="n">gs_access_msg</span><span class="o">.</span><span class="n">dst</span> <span class="o">=</span> <span class="n">gs_access_msg</span><span class="o">.</span><span class="n">src</span>
                    <span class="n">gs_access_msg</span><span class="o">.</span><span class="n">src</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
                    
                    <span class="c1"># send response to agent</span>
                    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">reqservice</span><span class="o">.</span><span class="n">send_json</span><span class="p">(</span><span class="n">gs_access_msg</span><span class="o">.</span><span class="n">to_json</span><span class="p">())</span>
                    
                    <span class="n">resp_msg</span> <span class="o">=</span> <span class="n">gs_access_msg</span>

                <span class="k">elif</span> <span class="n">NodeToEnvironmentMessageTypes</span><span class="p">[</span><span class="n">msg_type</span><span class="p">]</span> <span class="ow">is</span> <span class="n">NodeToEnvironmentMessageTypes</span><span class="o">.</span><span class="n">GP_ACCESS_SENSE</span><span class="p">:</span>
                    <span class="c1"># unpackage message</span>
                    <span class="n">gp_access_msg</span> <span class="o">=</span> <span class="n">GndPntAccessSenseMessage</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">F</span><span class="s1">&#39;RECEIVED, </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">gp_access_msg</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">logger_type</span><span class="o">=</span><span class="n">LoggerTypes</span><span class="o">.</span><span class="n">AGENT_TO_ENV_MESSAGE</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>

                    <span class="n">lat</span><span class="p">,</span> <span class="n">lon</span> <span class="o">=</span> <span class="n">gp_access_msg</span><span class="o">.</span><span class="n">target</span>
                    <span class="n">t_curr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_current_time</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Received ground point access sense message from </span><span class="si">{</span><span class="n">gp_access_msg</span><span class="o">.</span><span class="n">src</span><span class="si">}</span><span class="s1"> to (</span><span class="si">{</span><span class="n">lat</span><span class="si">}</span><span class="s1">°, </span><span class="si">{</span><span class="n">lon</span><span class="si">}</span><span class="s1">°) at simulation time t=</span><span class="si">{</span><span class="n">t_curr</span><span class="si">}</span><span class="s1">!&#39;</span><span class="p">)</span>

                    <span class="c1"># query ground point access database</span>
                    <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">gp_lat</span><span class="p">,</span> <span class="n">gp_lon</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">orbit_data</span><span class="p">[</span><span class="n">gp_access_msg</span><span class="o">.</span><span class="n">src</span><span class="p">]</span><span class="o">.</span><span class="n">find_gp_index</span><span class="p">(</span><span class="n">lat</span><span class="p">,</span> <span class="n">lon</span><span class="p">)</span>

                    <span class="n">is_accessing</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">orbit_data</span><span class="p">[</span><span class="n">gp_access_msg</span><span class="o">.</span><span class="n">src</span><span class="p">]</span><span class="o">.</span><span class="n">is_accessing_ground_point</span><span class="p">(</span><span class="n">gp_lat</span><span class="p">,</span> <span class="n">gp_lon</span><span class="p">,</span> <span class="n">t_curr</span><span class="p">)</span>
                    <span class="n">gp_access_msg</span><span class="o">.</span><span class="n">set_result</span><span class="p">(</span><span class="n">is_accessing</span><span class="p">)</span>
                    
                    <span class="c1"># change source and destination for response message</span>
                    <span class="n">gp_access_msg</span><span class="o">.</span><span class="n">dst</span> <span class="o">=</span> <span class="n">gp_access_msg</span><span class="o">.</span><span class="n">src</span>
                    <span class="n">gp_access_msg</span><span class="o">.</span><span class="n">src</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>

                    <span class="c1"># send response to agent</span>
                    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">reqservice</span><span class="o">.</span><span class="n">send_json</span><span class="p">(</span><span class="n">gp_access_msg</span><span class="o">.</span><span class="n">to_json</span><span class="p">())</span>

                    <span class="n">resp_msg</span> <span class="o">=</span> <span class="n">gp_access_msg</span>

                <span class="k">elif</span> <span class="n">NodeToEnvironmentMessageTypes</span><span class="p">[</span><span class="n">msg_type</span><span class="p">]</span> <span class="ow">is</span> <span class="n">NodeToEnvironmentMessageTypes</span><span class="o">.</span><span class="n">AGENT_INFO_SENSE</span><span class="p">:</span>
                    <span class="c1"># unpackage message</span>
                    <span class="n">agent_sense_msg</span> <span class="o">=</span> <span class="n">AgentSenseMessage</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">F</span><span class="s1">&#39;RECEIVED, </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">agent_sense_msg</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">logger_type</span><span class="o">=</span><span class="n">LoggerTypes</span><span class="o">.</span><span class="n">AGENT_TO_ENV_MESSAGE</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>

                    <span class="n">t_curr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_current_time</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Received agent information sense message from </span><span class="si">{</span><span class="n">agent_sense_msg</span><span class="o">.</span><span class="n">src</span><span class="si">}</span><span class="s1"> at simulation time t=</span><span class="si">{</span><span class="n">t_curr</span><span class="si">}</span><span class="s1">!&#39;</span><span class="p">)</span>

                    <span class="c1"># query agent state database</span>
                    <span class="n">pos</span><span class="p">,</span> <span class="n">vel</span><span class="p">,</span> <span class="n">is_eclipsed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">orbit_data</span><span class="p">[</span><span class="n">agent_sense_msg</span><span class="o">.</span><span class="n">src</span><span class="p">]</span><span class="o">.</span><span class="n">get_orbit_state</span><span class="p">(</span> <span class="n">t_curr</span><span class="p">)</span> 
                    <span class="n">agent_sense_msg</span><span class="o">.</span><span class="n">set_result</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">vel</span><span class="p">,</span> <span class="n">is_eclipsed</span><span class="p">)</span>
                    
                    <span class="c1"># change source and destination for response message</span>
                    <span class="n">agent_sense_msg</span><span class="o">.</span><span class="n">dst</span> <span class="o">=</span> <span class="n">agent_sense_msg</span><span class="o">.</span><span class="n">src</span>
                    <span class="n">agent_sense_msg</span><span class="o">.</span><span class="n">src</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>     
                    
                    <span class="c1"># send response to agent</span>
                    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">reqservice</span><span class="o">.</span><span class="n">send_json</span><span class="p">(</span><span class="n">agent_sense_msg</span><span class="o">.</span><span class="n">to_json</span><span class="p">())</span>

                    <span class="n">resp_msg</span> <span class="o">=</span> <span class="n">agent_sense_msg</span>

                <span class="k">elif</span> <span class="n">NodeToEnvironmentMessageTypes</span><span class="p">[</span><span class="n">msg_type</span><span class="p">]</span> <span class="ow">is</span> <span class="n">NodeToEnvironmentMessageTypes</span><span class="o">.</span><span class="n">AGENT_END_CONFIRMATION</span><span class="p">:</span>
                    <span class="c1"># register that agent node has gone offline mid-simulation</span>
                    <span class="c1"># (this agent node won&#39;t be considered when broadcasting simulation end)</span>
                    <span class="n">agent_end_conf_msg</span> <span class="o">=</span> <span class="n">AgentEndConfirmationMessage</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">F</span><span class="s1">&#39;RECEIVED, </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">agent_end_conf_msg</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">logger_type</span><span class="o">=</span><span class="n">LoggerTypes</span><span class="o">.</span><span class="n">AGENT_TO_ENV_MESSAGE</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>
                    
                    <span class="k">if</span> <span class="n">agent_end_conf_msg</span><span class="o">.</span><span class="n">src</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">offline_subscribers</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">offline_subscribers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">agent_end_conf_msg</span><span class="o">.</span><span class="n">src</span><span class="p">)</span>
                    
                    <span class="c1"># send blank response to agent</span>
                    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">send_blanc_response</span><span class="p">()</span>

                    <span class="n">resp_msg</span> <span class="o">=</span> <span class="kc">None</span>

                <span class="k">elif</span> <span class="n">NodeToEnvironmentMessageTypes</span><span class="p">[</span><span class="n">msg_type</span><span class="p">]</span> <span class="ow">is</span> <span class="n">NodeToEnvironmentMessageTypes</span><span class="o">.</span><span class="n">OBSERVATION_SENSE</span><span class="p">:</span>
                    <span class="c1"># unpackage message</span>
                    <span class="n">observation_sense_msg</span> <span class="p">:</span> <span class="n">ObservationSenseMessage</span> <span class="o">=</span> <span class="n">ObservationSenseMessage</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">F</span><span class="s1">&#39;RECEIVED, </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">observation_sense_msg</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">logger_type</span><span class="o">=</span><span class="n">LoggerTypes</span><span class="o">.</span><span class="n">AGENT_TO_ENV_MESSAGE</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>

                    <span class="n">lat</span> <span class="o">=</span> <span class="n">observation_sense_msg</span><span class="o">.</span><span class="n">lat</span>
                    <span class="n">lon</span> <span class="o">=</span> <span class="n">observation_sense_msg</span><span class="o">.</span><span class="n">lon</span>
                    <span class="n">t_curr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_current_time</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Received observation sense message from </span><span class="si">{</span><span class="n">observation_sense_msg</span><span class="o">.</span><span class="n">src</span><span class="si">}</span><span class="s1"> to (</span><span class="si">{</span><span class="n">lat</span><span class="si">}</span><span class="s1">°, </span><span class="si">{</span><span class="n">lon</span><span class="si">}</span><span class="s1">°) at simulation time t=</span><span class="si">{</span><span class="n">t_curr</span><span class="si">}</span><span class="s1">!&#39;</span><span class="p">)</span>
                    

                    <span class="c1"># with open(self.scenario_dir+&quot;sample_landsat_image.png&quot;, &quot;rb&quot;) as image_file:</span>
                    <span class="c1">#     encoded_string = base64.b64encode(image_file.read())</span>
                    <span class="c1"># observation_sense_msg.obs = encoded_string.decode(&#39;utf-8&#39;)</span>
                    <span class="n">observation_sense_msg</span><span class="o">.</span><span class="n">obs</span> <span class="o">=</span> <span class="s2">&quot;xd&quot;</span>
                    
                    <span class="c1"># change source and destination for response message</span>
                    <span class="n">observation_sense_msg</span><span class="o">.</span><span class="n">dst</span> <span class="o">=</span> <span class="n">observation_sense_msg</span><span class="o">.</span><span class="n">src</span>
                    <span class="n">observation_sense_msg</span><span class="o">.</span><span class="n">src</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> 

                    <span class="c1"># send response to agent</span>
                    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">reqservice</span><span class="o">.</span><span class="n">send_json</span><span class="p">(</span><span class="n">observation_sense_msg</span><span class="o">.</span><span class="n">to_json</span><span class="p">())</span>
                    <span class="c1"># img_req = ImgRequestMessage(self.name, EnvironmentModuleTypes.IMAGE_SERVER_MODULE.value, observation_sense_msg)</span>
                    <span class="c1"># await self.send_internal_message(img_req)</span>

                    <span class="n">resp_msg</span> <span class="o">=</span> <span class="n">observation_sense_msg</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># if message type is not supported, dump and ignore message</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">F</span><span class="s1">&#39;RECEIVED, UNKNOWN, UNKNOWN, </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">logger_type</span><span class="o">=</span><span class="n">LoggerTypes</span><span class="o">.</span><span class="n">AGENT_TO_ENV_MESSAGE</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>

                    <span class="n">msg_type</span> <span class="p">:</span> <span class="n">NodeToEnvironmentMessageTypes</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Message of type </span><span class="si">{</span><span class="n">msg_type</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s1"> not yet supported. Ignoring message...&#39;</span><span class="p">)</span>
                    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">send_blanc_response</span><span class="p">(</span><span class="n">dst</span><span class="o">=</span><span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;src&#39;</span><span class="p">,</span> <span class="s1">&#39;N/A&#39;</span><span class="p">))</span>
                    <span class="k">return</span>

                <span class="k">if</span> <span class="n">resp_msg</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">F</span><span class="s1">&#39;SENT, </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">resp_msg</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">logger_type</span><span class="o">=</span><span class="n">LoggerTypes</span><span class="o">.</span><span class="n">ENV_TO_AGENT_MESSAGE</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>

            <span class="k">except</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">CancelledError</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s1">&#39;Node message handling cancelled. Sending blank response...&#39;</span><span class="p">)</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">send_blanc_response</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;src&#39;</span><span class="p">,</span> <span class="s1">&#39;N/A&#39;</span><span class="p">))</span>
        
        <span class="k">try</span><span class="p">:</span>            
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s1">&#39;Acquiring access to request service port...&#39;</span><span class="p">)</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">reqservice_lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">msg_str</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">worker_task</span> <span class="o">=</span> <span class="kc">None</span>

                <span class="c1"># listen for requests</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s1">&#39;Waiting for agent messages.&#39;</span><span class="p">)</span>
                <span class="n">msg_str</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">reqservice</span><span class="o">.</span><span class="n">recv_json</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Agent message received!&#39;</span><span class="p">)</span>
                
                <span class="c1"># convert request to json</span>
                <span class="n">msg_dict</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">msg_str</span><span class="p">)</span>

                <span class="c1"># handle request</span>
                <span class="c1"># TODO Convert to pull-push fan to allow for multiple handlers to process messages in parallel</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Handling request...&#39;</span><span class="p">)</span>
                <span class="n">worker_task</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="n">message_worker</span><span class="p">(</span><span class="n">msg_dict</span><span class="p">))</span>
                <span class="k">await</span> <span class="n">worker_task</span>

        <span class="k">except</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">CancelledError</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">msg_str</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s1">&#39;Sending blank response...&#39;</span><span class="p">)</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">send_blanc_response</span><span class="p">(</span><span class="n">msg_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;src&#39;</span><span class="p">,</span> <span class="s1">&#39;N/A&#39;</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">worker_task</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s1">&#39;Cancelling response...&#39;</span><span class="p">)</span>
                <span class="n">worker_task</span> <span class="p">:</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Task</span>
                <span class="n">worker_task</span><span class="o">.</span><span class="n">cancel</span><span class="p">()</span>
                <span class="k">await</span> <span class="n">worker_task</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">poller</span> <span class="o">=</span> <span class="n">zmq</span><span class="o">.</span><span class="n">asyncio</span><span class="o">.</span><span class="n">Poller</span><span class="p">()</span>
                <span class="n">poller</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reqservice</span><span class="p">,</span> <span class="n">zmq</span><span class="o">.</span><span class="n">POLLIN</span><span class="p">)</span>
                <span class="n">poller</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reqservice</span><span class="p">,</span> <span class="n">zmq</span><span class="o">.</span><span class="n">POLLOUT</span><span class="p">)</span>

                <span class="n">evnt</span> <span class="o">=</span> <span class="k">await</span> <span class="n">poller</span><span class="o">.</span><span class="n">poll</span><span class="p">(</span><span class="mi">1000</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">evnt</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s1">&#39;Agent message received during shutdown process. Sending blank response..&#39;</span><span class="p">)</span>
                    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">send_blanc_response</span><span class="p">(</span><span class="n">msg_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;src&#39;</span><span class="p">,</span> <span class="s1">&#39;N/A&#39;</span><span class="p">))</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s1">&#39;Releasing request service port...&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">reqservice_lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
            <span class="k">return</span></div>

<div class="viewcode-block" id="EnvironmentServer.broadcast_handler"><a class="viewcode-back" href="../environment.html#environment.EnvironmentServer.broadcast_handler">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">broadcast_handler</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Listens to internal message inbox to see if any submodule wishes to broadcast information to all agents.</span>
<span class="sd">        Broadcast types supported:</span>
<span class="sd">            1- tic: informs all agents of environment server&#39;s current time</span>
<span class="sd">            2- eclipse_event: informs agents that an agent has entered eclipse. agents must ignore transmission if they are not the agent affected by the event</span>
<span class="sd">            3- gp_access_event: informs an agent that it can access or can no longer access a ground point. agents must ignore transmission if they are not the agent affected by the event</span>
<span class="sd">            4- gs_access_event: informs an agent that it can access or can no longer access a ground station. agents must ignore transmission if they are not the agent affected by the event</span>
<span class="sd">            5- agent_access_event: informs an agent that it can access or can no longer access another agent. agents must ignore transmission if they are not the agent affected by the event</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">publisher_queue</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">EnvironmentBroadcastMessage</span><span class="p">):</span>
                    <span class="c1"># if message to be broadcasted is not of any supported format, reject and dump</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Broadcast task of type </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span><span class="si">}</span><span class="s1"> not yet supported. Discarding task...&#39;</span><span class="p">)</span>
                    <span class="k">continue</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">msg</span><span class="o">.</span><span class="n">src</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
                        <span class="n">msg</span><span class="o">.</span><span class="n">src</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
                    
                    <span class="k">if</span> <span class="n">msg</span><span class="o">.</span><span class="n">dst</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Broadcast task of type </span><span class="si">{</span><span class="n">msg</span><span class="o">.</span><span class="n">get_type</span><span class="p">()</span><span class="si">}</span><span class="s1"> received! Destination originally set to this environment server. Discarding task...&#39;</span><span class="p">)</span>
                        <span class="k">continue</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Broadcast task of type </span><span class="si">{</span><span class="n">msg</span><span class="o">.</span><span class="n">get_type</span><span class="p">()</span><span class="si">}</span><span class="s1"> received! Publishing to all agents...&#39;</span><span class="p">)</span>

                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">TicEventBroadcast</span><span class="p">):</span>
                    <span class="n">t_next</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">t</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Updating internal clock to t=</span><span class="si">{</span><span class="n">t_next</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim_time</span><span class="o">.</span><span class="n">set_level</span><span class="p">(</span><span class="n">t_next</span><span class="p">)</span>

                <span class="c1"># broadcast message</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s1">&#39;Awaiting access to publisher socket...&#39;</span><span class="p">)</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">publisher_lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s1">&#39;Access to publisher socket acquired.&#39;</span><span class="p">)</span>

                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">publisher</span><span class="o">.</span><span class="n">send_json</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">to_json</span><span class="p">())</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s1">&#39;Broadcast sent&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">publisher_lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>

        <span class="k">except</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">CancelledError</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">publisher_lock</span><span class="o">.</span><span class="n">locked</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">publisher_lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span></div>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    --------------------</span>
<span class="sd">    HELPING FUNCTIONS</span>
<span class="sd">    --------------------    </span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="EnvironmentServer.network_config"><a class="viewcode-back" href="../environment.html#environment.EnvironmentServer.network_config">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">network_config</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates communication sockets and binds this environment to them.</span>

<span class="sd">        &#39;publisher&#39;: socket in charge of broadcasting messages to all simulation nodes in the simulation</span>
<span class="sd">        &#39;reqservice&#39;: socket in charge of receiving and answering messages from simulation nodes</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Activate network ports</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">context</span> <span class="o">=</span> <span class="n">zmq</span><span class="o">.</span><span class="n">asyncio</span><span class="o">.</span><span class="n">Context</span><span class="p">()</span>
    
        <span class="c1"># Assign ports to sockets</span>
        <span class="c1">## Set up socket to broadcast information to agents</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">environment_port_number</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">is_port_in_use</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">environment_port_number</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">environment_port_number</span><span class="si">}</span><span class="s2"> port already in use&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">publisher</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">zmq</span><span class="o">.</span><span class="n">PUB</span><span class="p">)</span>                   
        <span class="bp">self</span><span class="o">.</span><span class="n">publisher</span><span class="o">.</span><span class="n">sndhwm</span> <span class="o">=</span> <span class="mi">1100000</span>                                 <span class="c1">## set SNDHWM, so we don&#39;t drop messages for slow subscribers</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">publisher</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;tcp://*:</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">environment_port_number</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">publisher_lock</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Lock</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">publisher_queue</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Queue</span><span class="p">()</span>

        <span class="c1">## Set up socket to receive synchronization and measurement requests from agents</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">request_port_number</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">is_port_in_use</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request_port_number</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">request_port_number</span><span class="si">}</span><span class="s2"> port already in use&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reqservice</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">zmq</span><span class="o">.</span><span class="n">REP</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reqservice</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;tcp://*:</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">request_port_number</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reqservice_lock</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Lock</span><span class="p">()</span></div>

<div class="viewcode-block" id="EnvironmentServer.sync_agents"><a class="viewcode-back" href="../environment.html#environment.EnvironmentServer.sync_agents">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">sync_agents</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Awaits for all other agents to undergo their initialization and activation routines and to become online. Once they do, </span>
<span class="sd">        they will reach out to the environment through its &#39;reqservice&#39; socket and subscribe to future broadcasts from the </span>
<span class="sd">        environment&#39;s &#39;publisher&#39; socket.</span>

<span class="sd">        The environment will then create a ledger mapping which agents are assigned to which ports. This ledger will later be </span>
<span class="sd">        broadcasted to all agents.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># wait for agents to synchronize</span>
        <span class="n">subscriber_to_port_map</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">alive_subscribers</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">NUMBER_AGENTS</span><span class="p">:</span>
            <span class="c1"># wait for synchronization request</span>
            <span class="n">msg_str</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">reqservice</span><span class="o">.</span><span class="n">recv_json</span><span class="p">()</span> 
            <span class="n">msg</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">msg_str</span><span class="p">)</span>
            <span class="n">msg_type</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;@type&#39;</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">NodeToEnvironmentMessageTypes</span><span class="p">[</span><span class="n">msg_type</span><span class="p">]</span> <span class="o">!=</span> <span class="n">NodeToEnvironmentMessageTypes</span><span class="o">.</span><span class="n">SYNC_REQUEST</span> <span class="ow">or</span> <span class="n">msg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;port&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># ignore all messages that are not Sync Requests</span>
                <span class="k">continue</span>
            
            <span class="c1"># unpackage sync request</span>
            <span class="n">sync_req</span> <span class="o">=</span> <span class="n">SyncRequestMessage</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

            <span class="n">msg_src</span> <span class="o">=</span> <span class="n">sync_req</span><span class="o">.</span><span class="n">src</span>
            <span class="n">src_port</span> <span class="o">=</span> <span class="n">sync_req</span><span class="o">.</span><span class="n">port</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">NUMBER_OF_TIMED_COROUTINES_AGENTS</span> <span class="o">+=</span> <span class="n">sync_req</span><span class="o">.</span><span class="n">n_coroutines</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Received sync request from </span><span class="si">{</span><span class="n">msg_src</span><span class="si">}</span><span class="s1">! Checking if already synchronized...&#39;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span> 

            <span class="c1"># log subscriber confirmation</span>
            <span class="k">for</span> <span class="n">agent_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">AGENT_NAME_LIST</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">agent_name</span> <span class="ow">in</span> <span class="n">msg_src</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">agent_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">alive_subscribers</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">alive_subscribers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">agent_name</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent_name</span><span class="si">}</span><span class="s2"> is now synchronized to environment (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">alive_subscribers</span><span class="p">)</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">NUMBER_AGENTS</span><span class="si">}</span><span class="s2">).&quot;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>
                    
                    <span class="n">subscriber_to_port_map</span><span class="p">[</span><span class="n">msg_src</span><span class="p">]</span> <span class="o">=</span> <span class="n">src_port</span>
                    <span class="k">break</span>
                <span class="k">elif</span> <span class="p">(</span><span class="n">agent_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">alive_subscribers</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent_name</span><span class="si">}</span><span class="s2"> is already synchronized to environment (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">alive_subscribers</span><span class="p">)</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">NUMBER_AGENTS</span><span class="si">}</span><span class="s2">).&quot;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>
                <span class="k">elif</span> <span class="p">(</span><span class="n">msg_src</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">AGENT_NAME_LIST</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent_name</span><span class="si">}</span><span class="s2"> agent node not in list of agents for this environment (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">alive_subscribers</span><span class="p">)</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">NUMBER_AGENTS</span><span class="si">}</span><span class="s2">).&quot;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>
                    
            <span class="c1"># send synchronization reply</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">reqservice</span><span class="o">.</span><span class="n">send_string</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">subscriber_to_port_map</span></div>
                    
<div class="viewcode-block" id="EnvironmentServer.broadcast_sim_start"><a class="viewcode-back" href="../environment.html#environment.EnvironmentServer.broadcast_sim_start">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">broadcast_sim_start</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subscriber_to_port_map</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Broadcasts simulation start to all agents subscribed to this environment.</span>
<span class="sd">        Simulation start message also contains a ledger that maps agent names to ports to be connected to for inter-agent</span>
<span class="sd">        communications. This message also contains information about the clock-type being used in this simulation.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># create message</span>
        
        <span class="c1"># include clock information to message</span>
        <span class="n">clock_info</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">clock_info</span><span class="p">[</span><span class="s1">&#39;@type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">CLOCK_TYPE</span><span class="o">.</span><span class="n">name</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">CLOCK_TYPE</span> <span class="o">==</span> <span class="n">SimClocks</span><span class="o">.</span><span class="n">REAL_TIME</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">CLOCK_TYPE</span> <span class="o">==</span> <span class="n">SimClocks</span><span class="o">.</span><span class="n">REAL_TIME_FAST</span><span class="p">:</span>
            <span class="n">clock_info</span><span class="p">[</span><span class="s1">&#39;freq&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SIMULATION_FREQUENCY</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sim_time</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sim_time</span> <span class="o">=</span> <span class="n">Container</span><span class="p">()</span>

        <span class="c1"># package message and broadcast</span>
        <span class="n">sim_start_msg</span> <span class="o">=</span> <span class="n">SimulationStartBroadcastMessage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">subscriber_to_port_map</span><span class="p">,</span> <span class="n">clock_info</span><span class="p">)</span>
        <span class="n">sim_start_json</span> <span class="o">=</span> <span class="n">sim_start_msg</span><span class="o">.</span><span class="n">to_json</span><span class="p">()</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">publisher</span><span class="o">.</span><span class="n">send_json</span><span class="p">(</span><span class="n">sim_start_json</span><span class="p">)</span>

        <span class="c1"># log simulation start time</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">START_TIME</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>

        <span class="c1"># initiate tic request queue if simulation uses a synchronized server clock</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">CLOCK_TYPE</span> <span class="o">==</span> <span class="n">SimClocks</span><span class="o">.</span><span class="n">SERVER_EVENTS</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tic_request_queue</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Queue</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tic_request_queue_sorted</span> <span class="o">=</span> <span class="p">[]</span></div>
            
<div class="viewcode-block" id="EnvironmentServer.broadcast_sim_end"><a class="viewcode-back" href="../environment.html#environment.EnvironmentServer.broadcast_sim_end">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">broadcast_sim_end</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Broadcasts a message announcing the end of the simulation to all agents subscribed to this environment. </span>
<span class="sd">        All agents must aknowledge that they have received and processed this message for the simulation to end.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># wait for other processes to submit their final responses to other agents.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Awating access to request service socket...&#39;</span><span class="p">)</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">reqservice_lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
        
        <span class="c1"># broadcast simulation end to all subscribers</span>
        <span class="n">t_end</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">START_TIME</span>
        <span class="n">kill_msg</span> <span class="o">=</span> <span class="n">SimulationEndBroadcastMessage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">t_end</span><span class="p">)</span>
        
        <span class="c1"># self.message_logger.debug(f&#39;Broadcasting simulation end at t={t_end}[s]&#39;)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Broadcasting simulation end at t=</span><span class="si">{</span><span class="n">t_end</span><span class="si">}</span><span class="s1">[s]&#39;</span><span class="p">)</span>
        
        <span class="c1"># await self.publisher.send_json(kill_msg)</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">publisher</span><span class="o">.</span><span class="n">send_json</span><span class="p">(</span><span class="n">kill_msg</span><span class="o">.</span><span class="n">to_json</span><span class="p">())</span>
        
        <span class="c1"># wait for all agents to send their confirmation</span>
        <span class="c1"># self.request_logger.info(f&#39;Waiting for simulation end confirmation from {len(self.AGENT_NAME_LIST)} agents...&#39;)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Waiting for simulation end confirmation from </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">AGENT_NAME_LIST</span><span class="p">)</span><span class="si">}</span><span class="s1"> agents...&#39;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>
        
        <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">offline_subscribers</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">NUMBER_AGENTS</span><span class="p">:</span>
            <span class="c1"># wait for synchronization request</span>
            <span class="n">msg_str</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">reqservice</span><span class="o">.</span><span class="n">recv_json</span><span class="p">()</span> 
            <span class="n">msg_dict</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">msg_str</span><span class="p">)</span>
            <span class="n">msg_type</span> <span class="o">=</span> <span class="n">msg_dict</span><span class="p">[</span><span class="s1">&#39;@type&#39;</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">NodeToEnvironmentMessageTypes</span><span class="p">[</span><span class="n">msg_type</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">NodeToEnvironmentMessageTypes</span><span class="o">.</span><span class="n">AGENT_END_CONFIRMATION</span><span class="p">:</span>
                <span class="c1"># if request is not of the type end-of-simulation, then discard and wait for the next</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Request of type </span><span class="si">{</span><span class="n">msg_type</span><span class="si">}</span><span class="s1"> received at the end of simulation. Discarding request and sending a blank response...&#39;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">send_blanc_response</span><span class="p">()</span>
                <span class="k">continue</span>
            
            <span class="n">confirmation_msg</span> <span class="o">=</span> <span class="n">AgentEndConfirmationMessage</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">msg_dict</span><span class="p">)</span>

            <span class="c1"># self.request_logger.info(f&#39;Received simulation end confirmation from {confirmation_msg.src}!&#39;)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Received simulation end confirmation from </span><span class="si">{</span><span class="n">confirmation_msg</span><span class="o">.</span><span class="n">src</span><span class="si">}</span><span class="s1">!&#39;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>
            
            <span class="c1"># log subscriber confirmation</span>
            <span class="k">for</span> <span class="n">agent_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">AGENT_NAME_LIST</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">agent_name</span> <span class="ow">in</span> <span class="n">confirmation_msg</span><span class="o">.</span><span class="n">src</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">agent_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">offline_subscribers</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">offline_subscribers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">agent_name</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent_name</span><span class="si">}</span><span class="s2"> has ended its processes (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">offline_subscribers</span><span class="p">)</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">NUMBER_AGENTS</span><span class="si">}</span><span class="s2">).&quot;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>
                    <span class="k">break</span>
            
            <span class="c1"># send blank response</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">send_blanc_response</span><span class="p">()</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">reqservice_lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span></div>

<div class="viewcode-block" id="EnvironmentServer.set_up_results_directory"><a class="viewcode-back" href="../environment.html#environment.EnvironmentServer.set_up_results_directory">[docs]</a>    <span class="k">def</span> <span class="nf">set_up_results_directory</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scenario_dir</span><span class="p">):</span>
        <span class="n">scenario_results_path</span> <span class="o">=</span> <span class="n">scenario_dir</span> <span class="o">+</span> <span class="s1">&#39;/results&#39;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">scenario_results_path</span><span class="p">):</span>
            <span class="c1"># if directory does not exists, create it</span>
            <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">scenario_results_path</span><span class="p">)</span>

        <span class="n">enviroment_results_path</span> <span class="o">=</span> <span class="n">scenario_results_path</span> <span class="o">+</span> <span class="sa">f</span><span class="s1">&#39;/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">enviroment_results_path</span><span class="p">):</span>
            <span class="c1"># if directory already exists, cleare contents</span>
            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">enviroment_results_path</span><span class="p">):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">enviroment_results_path</span><span class="p">,</span> <span class="n">f</span><span class="p">))</span> 
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># if directory does not exist, create a new onw</span>
            <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">enviroment_results_path</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">scenario_results_path</span><span class="p">,</span> <span class="n">enviroment_results_path</span></div>


    <span class="c1"># def set_up_loggers(self):</span>
    <span class="c1">#     # set root logger to default settings</span>
    <span class="c1">#     logging.root.setLevel(logging.NOTSET)</span>
    <span class="c1">#     logging.basicConfig(level=logging.NOTSET)</span>

    <span class="c1">#     logger_names = [&#39;messages&#39;, &#39;requests&#39;, &#39;state&#39;, &#39;actions&#39;]</span>

    <span class="c1">#     loggers = []</span>
    <span class="c1">#     for logger_name in logger_names:</span>
    <span class="c1">#         path = self.ENVIRONMENT_RESULTS_DIR + f&#39;/{logger_name}.log&#39;</span>

    <span class="c1">#         if os.path.isdir(path):</span>
    <span class="c1">#             # if file already exists, delete</span>
    <span class="c1">#             os.remove(path)</span>

    <span class="c1">#         # create logger</span>
    <span class="c1">#         logger = logging.getLogger(f&#39;{self.name}_{logger_name}&#39;)</span>
    <span class="c1">#         logger.propagate = False</span>

    <span class="c1">#         # create handlers</span>
    <span class="c1">#         c_handler = logging.StreamHandler()</span>
    <span class="c1">#         if logger_name == &#39;actions&#39;:</span>
    <span class="c1">#             c_handler.setLevel(logging.DEBUG)</span>
    <span class="c1">#         else:</span>
    <span class="c1">#             c_handler.setLevel(logging.WARNING)</span>

    <span class="c1">#         f_handler = logging.FileHandler(path)</span>
    <span class="c1">#         f_handler.setLevel(logging.DEBUG)</span>

    <span class="c1">#         # add handlers to logger</span>
    <span class="c1">#         logger.addHandler(c_handler)</span>
    <span class="c1">#         logger.addHandler(f_handler)</span>

    <span class="c1">#         loggers.append(logger)</span>
    <span class="c1">#     return loggers</span>

<div class="viewcode-block" id="EnvironmentServer.environment_message_submitter"><a class="viewcode-back" href="../environment.html#environment.EnvironmentServer.environment_message_submitter">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">environment_message_submitter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">module_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Submits messages to itself whenever a submodule requests information from another module</span>
<span class="sd">        &quot;&quot;&quot;</span>        
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">send_internal_message</span><span class="p">(</span><span class="n">InternalMessage</span><span class="p">(</span><span class="n">module_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">msg</span><span class="p">))</span></div>

<div class="viewcode-block" id="EnvironmentServer.send_blanc_response"><a class="viewcode-back" href="../environment.html#environment.EnvironmentServer.send_blanc_response">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">send_blanc_response</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dst</span> <span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;N/A&#39;</span><span class="p">):</span>
        <span class="n">blanc</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">blanc_json</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">blanc</span><span class="p">)</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">reqservice</span><span class="o">.</span><span class="n">send_json</span><span class="p">(</span><span class="n">blanc_json</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;SENT, BLANK_RESPONSE, </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">, </span><span class="si">{</span><span class="n">dst</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">logger_type</span><span class="o">=</span><span class="n">LoggerTypes</span><span class="o">.</span><span class="n">ENV_TO_AGENT_MESSAGE</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span></div></div>
        
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">--------------------</span>
<span class="sd">MAIN</span>
<span class="sd">--------------------    </span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Initializing environment...&#39;</span><span class="p">)</span>
    <span class="n">scenario_dir</span> <span class="o">=</span> <span class="s2">&quot;./scenarios/scenario1_&quot;</span><span class="o">+</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="s2">&quot;/&quot;</span>
    <span class="n">dt</span> <span class="o">=</span> <span class="mf">4.6656879355937875</span>
    <span class="c1"># duration = 6048</span>
    <span class="n">duration</span> <span class="o">=</span> <span class="mi">86400</span>
    <span class="c1"># duration = 70</span>
    <span class="c1"># duration = 537 * dt </span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Simulation duration: </span><span class="si">{</span><span class="n">duration</span><span class="si">}</span><span class="s1">[s]&#39;</span><span class="p">)</span>

    <span class="c1"># environment = EnvironmentServer(scenario_dir, [], duration, clock_type=SimClocks.SERVER_EVENTS)</span>
    <span class="c1"># environment = EnvironmentServer(scenario_dir, [&#39;Mars1&#39;], duration, clock_type=SimClocks.SERVER_EVENTS)</span>
    <span class="c1"># environment = EnvironmentServer(scenario_dir, [&#39;Mars1&#39;], duration, clock_type=SimClocks.REAL_TIME_FAST, simulation_frequency=10)</span>
    <span class="n">environment</span> <span class="o">=</span> <span class="n">EnvironmentServer</span><span class="p">(</span><span class="n">scenario_dir</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;Landsat 9&#39;</span><span class="p">,</span> <span class="s1">&#39;Jason-3&#39;</span><span class="p">,</span> <span class="s1">&#39;CryoSat-2&#39;</span><span class="p">,</span> <span class="s1">&#39;Sentinel-6A&#39;</span><span class="p">,</span> <span class="s1">&#39;Sentinel-6B&#39;</span><span class="p">,</span> <span class="s1">&#39;SWOT&#39;</span><span class="p">,</span> <span class="s1">&#39;Iridium&#39;</span><span class="p">,</span> <span class="s1">&#39;Central Node&#39;</span><span class="p">],</span> <span class="n">duration</span><span class="p">,</span> <span class="n">clock_type</span><span class="o">=</span><span class="n">SimClocks</span><span class="o">.</span><span class="n">SERVER_EVENTS</span><span class="p">)</span>
    
    <span class="n">asyncio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">environment</span><span class="o">.</span><span class="n">live</span><span class="p">())</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;DONE&#39;</span><span class="p">)</span>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../index.html">3D-CHESS</a></h1>








<h3>Navigation</h3>
<p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../modules.html">dmas</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../index.html">Documentation overview</a><ul>
  <li><a href="index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2023, Alan Aguilar Jaramillo, Ben Gorr.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 5.2.2</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
    </div>

    

    
  </body>
</html>